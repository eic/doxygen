<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=9" />
<title>EIC Software: EicRoot/blob/master/eic/htc/KalmanFilter.cxx Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script> <link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script> 
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-155388685-3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-155388685-3');
</script>
</head>
<body>
	<div id="top">
		<!-- do not remove this div, it is closed by doxygen! -->
		<div id="titlearea">
			<table cellspacing="0" cellpadding="0">
				<tbody>
					<tr style="height: 56px;">
						<td id="projectlogo"><a href="https://eic.github.io/"><img
								alt="Logo" src="../../ion-collision-xparent-crop.png" height="100"/></a></td>
						<td style="padding-left: 0.5em;">
							<div id="projectname">
								EIC Software
							</div> 
							<div id="projectbrief">
								Reference for 
								<a href="https://eic.github.io/">EIC</a> 
								<a href="https://github.com/eic/">simulation and reconstruction software on GitHub</a>
							</div> 
						</td>
					</tr>
				</tbody>
			</table>
		</div>
		<!-- end header part -->
<!-- Generated by Doxygen 1.8.2 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Home&#160;page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../usergroup0.html"><span>External&#160;Links</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="../../search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('d5/dc2/KalmanFilter_8cxx_source.html','../../');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(11)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(12)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">KalmanFilter.cxx</div>  </div>
</div><!--header-->
<div class="contents">
<a href="../../d5/dc2/KalmanFilter_8cxx.html">Go to the documentation of this file.</a> Or view <a target="top" href="https://github.com/eic/EicRoot/blob/master/eic/htc/KalmanFilter.cxx">the newest version in sPHENIX GitHub for file KalmanFilter.cxx</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">// AYK (ayk@bnl.gov)</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">//    Kalman filter class routines; ported from HERMES/OLYMPUS sources; </span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment">//  cleaned up 2014/10/10;</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="preprocessor">#include &lt;cassert&gt;</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="preprocessor">#include &lt;cstdlib&gt;</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;</div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="preprocessor">#include &lt;Math/DistFunc.h&gt;</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;</div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="../../d1/d80/Splitter_8h.html">Splitter.h</a>&gt;</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="../../d7/ddf/htclib_8h.html">htclib.h</a>&gt;</span></div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="../../dc/db1/KalmanFilter_8h.html">KalmanFilter.h</a>&gt;</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;</div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="comment">// =======================================================================================</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;</div>
<div class="line"><a name="l00019"></a><span class="lineno"><a class="code" href="../../d6/d2a/classKalmanFilter.html#a6bef90f1a4f160db78e6244a690b3a01">   19</a></span>&#160;<a class="code" href="../../d6/d2a/classKalmanFilter.html#a6bef90f1a4f160db78e6244a690b3a01">KalmanFilter::KalmanFilter</a>(<span class="keywordtype">int</span> sdim)</div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;{</div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;  <span class="comment">// CHECK: this (void*) cast was required by Clang; need to check that the stuff still works;</span></div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;  <span class="comment">//@@@ assert(0);</span></div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;  <span class="comment">// Ok, this apparently kills &quot;nodes&quot; set initialization ...;</span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;  memset((<span class="keywordtype">void</span>*)<span class="keyword">this</span>, 0x00, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d2a/classKalmanFilter.html">KalmanFilter</a>));</div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;</div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;  <span class="comment">// NB: do not need xm[] vector calculation usually -&gt; can disable </span></div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;  <span class="comment">// via SetXmCalculationFlag() call;</span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;  <a class="code" href="../../d6/d2a/classKalmanFilter.html#a38ef340602577d163cb984fa270b0cae">mXmCalculationFlag</a> = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;</div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;  <span class="comment">// Just copy over all the stuff;</span></div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;  <a class="code" href="../../d6/d2a/classKalmanFilter.html#a06c2cdbf11c690bc94d7efccdf7b5b93">sDim</a>  = sdim;</div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;</div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;  <span class="comment">// Allocate buffer matrices for intermediate calculations;</span></div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;  <a class="code" href="../../d6/d2a/classKalmanFilter.html#a7c6a6b91058b6efa517098c2cd38b862">SMTX</a> = <span class="keyword">new</span> <a class="code" href="../../da/dd0/classKfMatrix.html">KfMatrix</a>(sdim, sdim); </div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;  <a class="code" href="../../d6/d2a/classKalmanFilter.html#a72a17d3b2c3b2a81ab080676aa9d5060">SVEC</a> = <span class="keyword">new</span> <a class="code" href="../../d5/d12/KfMatrix_8h.html#a6dff51a39c4030969abda80d5b9f58ab">KfVector</a>(sdim);        </div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;  <a class="code" href="../../d6/d2a/classKalmanFilter.html#a411c809178a27e377589a79f57ec565c">QVEC</a> = <span class="keyword">new</span> <a class="code" href="../../d5/d12/KfMatrix_8h.html#a6dff51a39c4030969abda80d5b9f58ab">KfVector</a>(sdim);        </div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;  <a class="code" href="../../d6/d2a/classKalmanFilter.html#a7b48f0a8dda44643d86004065d9d6d96">mLastFilterPass</a> = <a class="code" href="../../d6/d2a/classKalmanFilter.html#a5592d57642d917049cd5df82ba5f1301a2d4913d81db3e15a46103a44ca890eb8">KalmanFilter::Undefined</a>;</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;  <span class="comment">// Unity matrix can be global;</span></div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;  <a class="code" href="../../d6/d2a/classKalmanFilter.html#a35114b016772134102611c1eef19edea">SU</a> = <span class="keyword">new</span> <a class="code" href="../../da/dd0/classKfMatrix.html">KfMatrix</a>(sdim, sdim); </div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;  <a class="code" href="../../d6/d2a/classKalmanFilter.html#a35114b016772134102611c1eef19edea">SU</a>-&gt;<a class="code" href="../../da/dd0/classKfMatrix.html#a30c706ecfbb7de00127f32d6392b6f86">Unity</a>();</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;</div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;  <span class="comment">// Set reasonable default values for these 2 variables ...;</span></div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;  <a class="code" href="../../d6/d2a/classKalmanFilter.html#aa3cc65d9936401e3195b3a483deff0cb">mMinFilterChiSquareCCDF</a>      = <a class="code" href="../../dc/db1/KalmanFilter_8h.html#a01b52ef500f3bb30cbe717c871f24fe2">_MIN_FILTER_CHI_SQUARE_CCDF_DEFAULT_</a>;</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;  <a class="code" href="../../d6/d2a/classKalmanFilter.html#a73c606d3c5d8f511e8540158996c0311">mMinSmootherChiSquareCCDF</a>    = <a class="code" href="../../dc/db1/KalmanFilter_8h.html#a58d1401b42b95b07fcc7f03f4af8f592">_MIN_SMOOTHER_CHI_SQUARE_CCDF_DEFAULT_</a>;</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;  <span class="comment">// ... and for these two as well;</span></div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;  <a class="code" href="../../d6/d2a/classKalmanFilter.html#affec4d56d4efba01b15b6a7910ff1115">mMaxFixablePositivityScrewup</a> = <a class="code" href="../../dc/db1/KalmanFilter_8h.html#a074cd31b5eb1582d0565ec6a52fe1b55">_MAX_FIXABLE_POSITIVITY_SCREWUP_DEFAULT_</a>;</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;  <a class="code" href="../../d6/d2a/classKalmanFilter.html#a3939f3d7b5dfb4e1be546384241050a2">mPositivityCorrelationFix</a>    = <a class="code" href="../../dc/db1/KalmanFilter_8h.html#a0e7c04572a8f2c8b7357cce7c9650671">_POSITIVITY_CORRELATION_FIX_DEFAULT_</a>;</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;  <span class="comment">// Force CP, CF &amp; CS matrices positivity check at each step; think twice</span></div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;  <span class="comment">// befor making these options configurable -&gt; high-level routines expect that </span></div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;  <span class="comment">// if Kalman chain succeeded, all nodes have &quot;clean&quot; CS[][], at least; </span></div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;  <a class="code" href="../../d6/d2a/classKalmanFilter.html#aeb0ed86093c9541a7b9a3d0ff6ba2617">mPositivityCheck</a> = <a class="code" href="../../d6/d2a/classKalmanFilter.html#ac37d594f0e018efd90014a92c89cc151">mForceSymmetrization</a> = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;  <span class="comment">// NB: this value may require some task-specific tuning;  </span></div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;  <a class="code" href="../../d6/d2a/classKalmanFilter.html#afcb3fe5f3e6ba32e49e89a9468d64169">mRFCutoffValue</a>   = <a class="code" href="../../dc/db1/KalmanFilter_8h.html#ac626f06f3cba433542493a4c8a15161d">_RF_CUTOFF_DEFAULT_</a>;</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;} <span class="comment">// KalmanFilter::KalmanFilter()</span></div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;<span class="comment">// ---------------------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;<span class="comment">//   Put a new node in a proper place in the chain accoring to it&#39;s Z coordinate; </span></div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;</div>
<div class="line"><a name="l00064"></a><span class="lineno"><a class="code" href="../../d6/d2a/classKalmanFilter.html#a1e6a94b24e4c9a6cf3dfade25482f153">   64</a></span>&#160;<a class="code" href="../../de/ddb/classKalmanNode.html">KalmanNode</a> *<a class="code" href="../../d6/d2a/classKalmanFilter.html#a1e6a94b24e4c9a6cf3dfade25482f153">KalmanFilter::AddNode</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d3/d16/VstRadLength_8C.html#a5ac083a645d964373f022d03df4849c8">name</a>, <span class="keywordtype">double</span> <a class="code" href="../../dc/d49/HelixHough__allButKappaRange__sse_8cpp.html#a9593b8fc874ec60dacdcbeaec75a8235">z</a>, <span class="keywordtype">int</span> mdim, </div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;          <span class="keyword">const</span> <span class="keywordtype">bool</span> nonLinearTransportFlags[2]<span class="comment">/*, void *ptr*/</span>)</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;{ </div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;  <a class="code" href="../../de/ddb/classKalmanNode.html">KalmanNode</a> *node = <a class="code" href="../../d6/d2a/classKalmanFilter.html#a457a1b99f966a8021769481da8164a05">AllocateNode</a>();</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;  <span class="keywordflow">if</span> (!node) <span class="keywordflow">return</span> NULL;</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;  assert(mdim &gt;= 0);</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;  node-&gt;<a class="code" href="../../de/ddb/classKalmanNode.html#a51e739402d1bebf0c27759b0b0be13d9">mDim</a>  = mdim;</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;  <span class="comment">// Assign user back-door pointer;</span></div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;  <span class="comment">//node-&gt;mBackDoorPointer  = ptr;</span></div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;  <span class="comment">// Assign non-linear transport flags;</span></div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;  <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> fb=<a class="code" href="../../d6/d2a/classKalmanFilter.html#a5592d57642d917049cd5df82ba5f1301a0ee44748271f2bf9a0c1e59671792ba0">KalmanFilter::Forward</a>; fb&lt;=<a class="code" href="../../d6/d2a/classKalmanFilter.html#a5592d57642d917049cd5df82ba5f1301ab9d2e05c5574456f81aa222c76f0abe5">KalmanFilter::Backward</a>; fb++)</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;    node-&gt;<a class="code" href="../../de/ddb/classKalmanNode.html#abacedb8b2f6d0b425f9640d88273609a">mNonLinearTransportFlags</a>[fb] = nonLinearTransportFlags[fb];</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;  <span class="comment">// Allocate name if given;</span></div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;  if (name) {</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;    node-&gt;<a class="code" href="../../de/ddb/classKalmanNode.html#a1306bb9d8469ee77e2693bf16383a395">mName</a> = strdup(name);</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;    <span class="keywordflow">if</span> (!node-&gt;<a class="code" href="../../de/ddb/classKalmanNode.html#a1306bb9d8469ee77e2693bf16383a395">mName</a>) <span class="keywordflow">return</span> NULL;</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;  } <span class="comment">//if</span></div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;  node-&gt;<a class="code" href="../../de/ddb/classKalmanNode.html#a635dd413c2734786d152e64aa0b1c7a0">SetZ</a>(z);  </div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;  node-&gt;<a class="code" href="../../de/ddb/classKalmanNode.html#a55bcf1838e20af0d0dd12ec98b4196c1">AllocateKfMatrices</a>(<a class="code" href="../../d6/d2a/classKalmanFilter.html#a06c2cdbf11c690bc94d7efccdf7b5b93">sDim</a>);</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;  <span class="comment">// As of Oct&#39;2015 the double-linked list will be created later; just put </span></div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;  <span class="comment">// everything in the Z-ordered multi-map and return;</span></div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;  <a class="code" href="../../d6/d2a/classKalmanFilter.html#a5b7f2f8bf70c38fbea402a7ebc07f280">mKalmanNodePool</a>.insert(std::pair&lt;double, KalmanNode*&gt;(z, node));</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;  <span class="keywordflow">return</span> node;</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;} <span class="comment">// KalmanFilter::AddNode()</span></div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;<span class="comment">// ---------------------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;</div>
<div class="line"><a name="l00100"></a><span class="lineno"><a class="code" href="../../d6/d2a/classKalmanFilter.html#a8b30371bca3e6dc697ee6ec300c4af57">  100</a></span>&#160;<a class="code" href="../../de/ddb/classKalmanNode.html">KalmanNode</a> *<a class="code" href="../../d6/d2a/classKalmanFilter.html#a8b30371bca3e6dc697ee6ec300c4af57">KalmanFilter::AddNodeWrapper</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d3/d16/VstRadLength_8C.html#a5ac083a645d964373f022d03df4849c8">name</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *format, <span class="keywordtype">double</span> <a class="code" href="../../dc/d49/HelixHough__allButKappaRange__sse_8cpp.html#a9593b8fc874ec60dacdcbeaec75a8235">z</a>, <span class="keywordtype">int</span> mdim) </div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;{</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;  <span class="keywordtype">char</span> <a class="code" href="../../da/d40/classbuffer.html">buffer</a>[<a class="code" href="../../d1/d80/Splitter_8h.html#a3fd746f5195b492c72ecacea0d07dcff">STRING_LEN_MAX</a>];</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;  <span class="comment">// No tricks in this call -&gt; either both FB-directions &quot;true&quot; or both &quot;false&quot;;</span></div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;  <span class="keywordtype">bool</span> nonLinearFlags[2] = {<a class="code" href="../../d6/d2a/classKalmanFilter.html#a183aeef54adb9ddcbed2f923095eccae">NeedNonLinearTransport</a>(z), <a class="code" href="../../d6/d2a/classKalmanFilter.html#a183aeef54adb9ddcbed2f923095eccae">NeedNonLinearTransport</a>(z)};</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;  <span class="comment">// Construct name if NULL; use provided format and &#39;z&#39; variable otherwise;</span></div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;  <span class="keywordflow">if</span> (!name) snprintf(buffer, <a class="code" href="../../d1/d80/Splitter_8h.html#a3fd746f5195b492c72ecacea0d07dcff">STRING_LEN_MAX</a>-1, format, z);</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;  <span class="keywordflow">return</span> <a class="code" href="../../d6/d2a/classKalmanFilter.html#a1e6a94b24e4c9a6cf3dfade25482f153">AddNode</a>(name ? name : buffer, z, mdim, nonLinearFlags);</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;} <span class="comment">// KalmanFilter::AddNodeWrapper()</span></div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;<span class="comment">// ---------------------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;</div>
<div class="line"><a name="l00114"></a><span class="lineno"><a class="code" href="../../d6/d2a/classKalmanFilter.html#a16254eb12292f89b6c3025d1982e7893">  114</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../d6/d2a/classKalmanFilter.html#a16254eb12292f89b6c3025d1982e7893">KalmanFilter::BuildNodeList</a>() </div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;{</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;  <a class="code" href="../../d6/d2a/classKalmanFilter.html#aac222f7c48aa36a619f3e81c9a1eae1d">mHead</a> = <a class="code" href="../../d6/d2a/classKalmanFilter.html#a1ac7f3cfd1048e7552604e87a2ecf371">mTail</a> = 0;</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;  <span class="comment">// Nodes are Z-ordered in the multi-map; so just go arrange a double-linked list;</span></div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;  <span class="keywordflow">for</span>(std::map&lt;double, KalmanNode*&gt;::iterator <a class="code" href="../../d5/d0b/changehitformat_8cc.html#a592a0cf34c13b7b53e37c2791a6a982e">it</a>=<a class="code" href="../../d6/d2a/classKalmanFilter.html#a5b7f2f8bf70c38fbea402a7ebc07f280">mKalmanNodePool</a>.begin(); </div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;      <a class="code" href="../../d5/d0b/changehitformat_8cc.html#a592a0cf34c13b7b53e37c2791a6a982e">it</a> != <a class="code" href="../../d6/d2a/classKalmanFilter.html#a5b7f2f8bf70c38fbea402a7ebc07f280">mKalmanNodePool</a>.end(); <a class="code" href="../../d5/d0b/changehitformat_8cc.html#a592a0cf34c13b7b53e37c2791a6a982e">it</a>++) {</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;    <a class="code" href="../../de/ddb/classKalmanNode.html">KalmanNode</a> *node = <a class="code" href="../../d5/d0b/changehitformat_8cc.html#a592a0cf34c13b7b53e37c2791a6a982e">it</a>-&gt;second;</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;    <span class="comment">// Part of the nodes may be de-activated on purpose (say, no hit);</span></div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;    <span class="keywordflow">if</span> (!node-&gt;<a class="code" href="../../de/ddb/classKalmanNode.html#a659e60026c071fc0581aa6dd0c2efb40">IsActive</a>()) <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d2a/classKalmanFilter.html#aac222f7c48aa36a619f3e81c9a1eae1d">mHead</a>)</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;      <a class="code" href="../../d6/d2a/classKalmanFilter.html#aac222f7c48aa36a619f3e81c9a1eae1d">mHead</a> = node;</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;    <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;      <a class="code" href="../../d6/d2a/classKalmanFilter.html#a1ac7f3cfd1048e7552604e87a2ecf371">mTail</a>-&gt;<a class="code" href="../../de/ddb/classKalmanNode.html#ad77fdd3ea55c550b092613249e93eae5">SetNext</a>(node);</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;      node-&gt;<a class="code" href="../../de/ddb/classKalmanNode.html#ae9a279ccd1d5fe73fe4ff6831154d81a">SetPrev</a>(<a class="code" href="../../d6/d2a/classKalmanFilter.html#a1ac7f3cfd1048e7552604e87a2ecf371">mTail</a>);</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;    } <span class="comment">//if</span></div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;    <span class="comment">// This is needed since BuildNodeList() can be called more than once;</span></div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;    node-&gt;<a class="code" href="../../de/ddb/classKalmanNode.html#ad77fdd3ea55c550b092613249e93eae5">SetNext</a>(0);</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;    <a class="code" href="../../d6/d2a/classKalmanFilter.html#a1ac7f3cfd1048e7552604e87a2ecf371">mTail</a> = node;</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;    <span class="comment">//printf(&quot;KalmanFilter::BuildNodeList(): %7.2f %s -&gt; %d %d\n&quot;, </span></div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;    <span class="comment">//     it-&gt;first, node-&gt;GetName(), node-&gt;IsActive(), node-&gt;IsFired());</span></div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;  } <span class="comment">//for it</span></div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;} <span class="comment">// KalmanFilter::BuildNodeList()</span></div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;<span class="comment">// ---------------------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;</div>
<div class="line"><a name="l00145"></a><span class="lineno"><a class="code" href="../../d6/d2a/classKalmanFilter.html#a6416ee1ca85f5d68fb1e4789db0866e2">  145</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="../../d6/d2a/classKalmanFilter.html#a6416ee1ca85f5d68fb1e4789db0866e2">KalmanFilter::Configure</a>(<span class="keyword">const</span> <a class="code" href="../../d0/d6b/classStringList.html">StringList</a> *<a class="code" href="../../d5/d92/namespaceconfigureMap.html#a9836284b2e2e560cadb1aa2c625b3572">config</a><span class="comment">/*, const char *format*/</span>)</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;{</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;  <span class="comment">// Use presently available nodes to build the linked list;</span></div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;  <a class="code" href="../../d6/d2a/classKalmanFilter.html#a16254eb12292f89b6c3025d1982e7893">BuildNodeList</a>();</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;  <span class="keywordflow">for</span>(<span class="keyword">const</span> <a class="code" href="../../d0/d6b/classStringList.html">StringList</a> *str=config; str; str=str-&gt;<a class="code" href="../../d0/d6b/classStringList.html#aee3b0ac507bc1abc3d4e7e56b21acfb1">mNextString</a>) {</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;    <a class="code" href="../../d1/d50/classNodeGroup.html">NodeGroup</a> **gtail = &amp;<a class="code" href="../../d6/d2a/classKalmanFilter.html#afb318b6582f705dbf02fd79005e125b2">mNodeGroups</a>;</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;    <span class="comment">// Copy over and save original qstr pointer (help free());</span></div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;    <span class="keywordtype">char</span> *qstr = strdup(str-&gt;mString), *qqstr = qstr;</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;    assert(qqstr);</div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;    qqstr += strlen(<a class="code" href="../../dc/db1/KalmanFilter_8h.html#acda96e297da4c236f24444735f1f8826">_FIRED_RPLANE_PREFIX_</a>);</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;    <span class="comment">// Ok, now parse the string and create node groups; </span></div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;    <span class="keywordflow">for</span>( ; ; ) {</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;      <span class="keywordtype">char</span> *comma = strchr(qqstr, <span class="charliteral">&#39;,&#39;</span>);</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;  </div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;      <span class="comment">// Substring is over --&gt; break;</span></div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;      <span class="keywordflow">if</span> (!*qqstr) <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;      </div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;      <span class="comment">// If comma was found, set to 0;</span></div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;      <span class="keywordflow">if</span> (comma) *comma = 0;</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;      </div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;      {</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;  <a class="code" href="../../d0/d6b/classStringList.html">StringList</a> **ltail;</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;  <span class="comment">// Create new group;</span></div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;  <a class="code" href="../../d1/d50/classNodeGroup.html">NodeGroup</a> *group = *gtail = <span class="keyword">new</span> <a class="code" href="../../d1/d50/classNodeGroup.html">NodeGroup</a>();</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;  </div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;  assert(group);</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;  </div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;  <span class="comment">// Parse group substring; first suffix: min number of fired nodes; </span></div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;  {</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;    <span class="keywordtype">char</span> *semicolon = strchr(qqstr, <span class="charliteral">&#39;:&#39;</span>);</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;    </div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;    <span class="comment">// Semicolon must be there;</span></div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;    <span class="keywordflow">if</span> (!semicolon)</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;      <a class="code" href="../../d7/ddf/htclib_8h.html#a3cf74af3f9d9115ac8963ee8f38ea812">_RETURN_</a>(-1, <span class="stringliteral">&quot;&#39;fired-node-num&#39;: no semicolon found!\n&quot;</span>);</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;    </div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;    <span class="comment">// Determine min number of fired rplanes in this group;</span></div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;    group-&gt;<a class="code" href="../../d1/d50/classNodeGroup.html#a57e9796af95a88e88a249fd8bfa0e6eb">mFiredNodeNumMin</a> = atoi(semicolon+1);</div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;    <span class="keywordflow">if</span> (group-&gt;<a class="code" href="../../d1/d50/classNodeGroup.html#a57e9796af95a88e88a249fd8bfa0e6eb">mFiredNodeNumMin</a> &lt; 0)</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;      <a class="code" href="../../d7/ddf/htclib_8h.html#a3cf74af3f9d9115ac8963ee8f38ea812">_RETURN_</a>(-1, <span class="stringliteral">&quot;&#39;fired-node-num&#39;: value &gt;=0 expected!\n&quot;</span>);</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;    </div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;    *semicolon = 0;</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;  }</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;  </div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;  <span class="comment">// Then group rplane member prefices;</span></div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;  ltail = &amp;group-&gt;<a class="code" href="../../d1/d50/classNodeGroup.html#a8b2d35891f668056c5a13af6bc927bc3">mPrefices</a>;</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;  <span class="keywordflow">for</span>( ; ; ) {</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;    <span class="keywordtype">char</span> *plus = strchr(qqstr, <span class="charliteral">&#39;+&#39;</span>);</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;  </div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;    <span class="comment">// Substring is over --&gt; break;</span></div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;    <span class="keywordflow">if</span> (!*qqstr) <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;    </div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;    <span class="comment">// If plus was found, set to 0;</span></div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;    <span class="keywordflow">if</span> (plus) *plus = 0;</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;    </div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;    {</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;      <a class="code" href="../../d0/d6b/classStringList.html">StringList</a> *<a class="code" href="../../d7/dc9/namespacecharm__jet__coverage.html#aa8c5f05ccb341029dd3c972f93ad3218">list</a> = *ltail = <span class="keyword">new</span> <a class="code" href="../../d0/d6b/classStringList.html">StringList</a>();</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;      </div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;      assert(list);</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;      </div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;      list-&gt;<a class="code" href="../../d0/d6b/classStringList.html#a169ba217288b4ae24de34f2463447df9">mString</a> = strdup(qqstr);</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;      assert(list-&gt;<a class="code" href="../../d0/d6b/classStringList.html#a169ba217288b4ae24de34f2463447df9">mString</a>);      </div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;      </div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;      ltail = &amp;list-&gt;<a class="code" href="../../d0/d6b/classStringList.html#aee3b0ac507bc1abc3d4e7e56b21acfb1">mNextString</a>;</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;    }</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;    </div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;    <span class="comment">// Substring is over --&gt; break;</span></div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;    <span class="keywordflow">if</span> (!plus) <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;    </div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;    <span class="comment">// Switch to the next group substring;</span></div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;    qqstr = plus + 1;</div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;  } <span class="comment">/*for inf*/</span></div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;  </div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;    <span class="comment">// And now loop through all nodes and allocate </span></div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;    <span class="comment">// those which match one of the prefix patterns</span></div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;    <span class="comment">// in a linked list;</span></div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;  {</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;    <a class="code" href="../../dc/d54/classNodeList.html">NodeList</a> **ntail = &amp;group-&gt;<a class="code" href="../../d1/d50/classNodeGroup.html#a73d50a6f13e9ca7d6d37c05e18bc9427">mNodeList</a>;</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;    </div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;    <span class="keywordflow">for</span>(<a class="code" href="../../de/ddb/classKalmanNode.html">KalmanNode</a> *node=<a class="code" href="../../d6/d2a/classKalmanFilter.html#aac222f7c48aa36a619f3e81c9a1eae1d">mHead</a>; node; node=node-&gt;<a class="code" href="../../de/ddb/classKalmanNode.html#a065c3feb4f0dd3ab087924a68444ae44">GetNext</a>(<a class="code" href="../../d6/d2a/classKalmanFilter.html#a5592d57642d917049cd5df82ba5f1301a0ee44748271f2bf9a0c1e59671792ba0">KalmanFilter::Forward</a>)) {</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;      <span class="keywordflow">if</span> (!node-&gt;mName) <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;      <span class="keywordflow">for</span>(<a class="code" href="../../d0/d6b/classStringList.html">StringList</a> *<a class="code" href="../../d7/dc9/namespacecharm__jet__coverage.html#aa8c5f05ccb341029dd3c972f93ad3218">list</a>=group-&gt;<a class="code" href="../../d1/d50/classNodeGroup.html#a8b2d35891f668056c5a13af6bc927bc3">mPrefices</a>; <a class="code" href="../../d7/dc9/namespacecharm__jet__coverage.html#aa8c5f05ccb341029dd3c972f93ad3218">list</a>; <a class="code" href="../../d7/dc9/namespacecharm__jet__coverage.html#aa8c5f05ccb341029dd3c972f93ad3218">list</a>=<a class="code" href="../../d7/dc9/namespacecharm__jet__coverage.html#aa8c5f05ccb341029dd3c972f93ad3218">list</a>-&gt;mNextString)</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;        <span class="keywordflow">if</span> (!<a class="code" href="../../d7/ddf/htclib_8h.html#a9ebaf4bb042d846ab6cf7cae72252ba1">check_prefix</a>(node-&gt;mName, <a class="code" href="../../d7/dc9/namespacecharm__jet__coverage.html#aa8c5f05ccb341029dd3c972f93ad3218">list</a>-&gt;mString)) {</div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;    <a class="code" href="../../dc/d54/classNodeList.html">NodeList</a> *nlist = *ntail = <span class="keyword">new</span> <a class="code" href="../../dc/d54/classNodeList.html">NodeList</a>();</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;    assert(nlist);</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;    </div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;    group-&gt;<a class="code" href="../../d1/d50/classNodeGroup.html#a7eea7d79b72c0dd53aee7b64a7566e7e">mAllNodeNum</a>++;</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;    nlist-&gt;<a class="code" href="../../dc/d54/classNodeList.html#a03fa90ab5e0bfb83de2c9511f56f29f5">mNode</a> = node;</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;    </div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;    <span class="comment">// And fill out back door pointer in node frame;</span></div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;    node-&gt;<a class="code" href="../../de/ddb/classKalmanNode.html#a70cc8225abbac015d6eb8ad4ba62aaf6">mNodeGroupNum</a>++;</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;    node-&gt;mNodeGroups = </div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;      (<a class="code" href="../../d1/d50/classNodeGroup.html">NodeGroup</a>**)realloc(node-&gt;mNodeGroups,</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;               node-&gt;mNodeGroupNum*<span class="keyword">sizeof</span>(<span class="keywordtype">void</span>*));</div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;    assert(node-&gt;mNodeGroups);</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;    node-&gt;mNodeGroups[node-&gt;mNodeGroupNum-1] = group;</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;    </div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;    ntail = &amp;nlist-&gt;<a class="code" href="../../dc/d54/classNodeList.html#a8d8cf32d4f3349850aa8828de4b014e2">mNextNode</a>;</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;    </div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;        } <span class="comment">//for list .. if</span></div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;    } <span class="comment">//for node</span></div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;  } </div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;</div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;  <span class="comment">// Sanity check, please;</span></div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;  <span class="comment">//printf(&quot;%d %d\n&quot;, group-&gt;mFiredNodeNumMin, group-&gt;mAllNodeNum);</span></div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;  <span class="keywordflow">if</span> (group-&gt;<a class="code" href="../../d1/d50/classNodeGroup.html#a57e9796af95a88e88a249fd8bfa0e6eb">mFiredNodeNumMin</a> &gt; group-&gt;<a class="code" href="../../d1/d50/classNodeGroup.html#a7eea7d79b72c0dd53aee7b64a7566e7e">mAllNodeNum</a>)</div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;    <a class="code" href="../../d7/ddf/htclib_8h.html#a3cf74af3f9d9115ac8963ee8f38ea812">_RETURN_</a>(-1, <span class="stringliteral">&quot;&#39;fired-node-num&#39;: limit too high!\n&quot;</span>);</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;  </div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;  gtail = &amp;group-&gt;<a class="code" href="../../d1/d50/classNodeGroup.html#a06b36a722306b8020115bcb6f8d501c7">mNextGroup</a>;</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;      } </div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;</div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;      <span class="comment">// Substring is over --&gt; break;</span></div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;      <span class="keywordflow">if</span> (!comma) <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;</div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;  <span class="comment">// Switch to the next group substring;</span></div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;      qqstr = comma + 1;</div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;    } <span class="comment">//for inf</span></div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;</div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;    free(qstr);</div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;  } <span class="comment">//for str</span></div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;</div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;  <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d2a/classKalmanFilter.html#afb318b6582f705dbf02fd79005e125b2">mNodeGroups</a>) </div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;    <a class="code" href="../../d7/ddf/htclib_8h.html#a3cf74af3f9d9115ac8963ee8f38ea812">_RETURN_</a>(-1, <span class="stringliteral">&quot;&#39;--kalman-tuning fired-node-min&#39; option missing!\n&quot;</span>);</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;</div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;<span class="preprocessor">#if _LATER_</span></div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;<span class="preprocessor"></span>  <span class="comment">// Well, it looks this code is of interest for the generic Kalman filter as well;</span></div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;  {</div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;    <span class="comment">// Loop through all nodes and fill &quot;too big&quot; gaps in Z; </span></div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;    <span class="comment">// NB: this call should be done AFTER parser (see above);</span></div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2a/classKalmanFilter.html#ac3bc5f9249588956e1a6999e29bc2e7e">mNodeGapMax</a>)</div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;      <span class="keywordflow">for</span>(<a class="code" href="../../de/ddb/classKalmanNode.html">KalmanNode</a> *knode=<a class="code" href="../../d6/d2a/classKalmanFilter.html#aac222f7c48aa36a619f3e81c9a1eae1d">mHead</a>; knode &amp;&amp; knode-&gt;<a class="code" href="../../de/ddb/classKalmanNode.html#a065c3feb4f0dd3ab087924a68444ae44">GetNext</a>(<a class="code" href="../../d6/d2a/classKalmanFilter.html#a5592d57642d917049cd5df82ba5f1301a0ee44748271f2bf9a0c1e59671792ba0">KalmanFilter::Forward</a>); </div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;    knode=knode-&gt;<a class="code" href="../../de/ddb/classKalmanNode.html#a065c3feb4f0dd3ab087924a68444ae44">GetNext</a>(<a class="code" href="../../d6/d2a/classKalmanFilter.html#a5592d57642d917049cd5df82ba5f1301a0ee44748271f2bf9a0c1e59671792ba0">KalmanFilter::Forward</a>))</div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;      {</div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;  <span class="keywordtype">double</span> zz = knode-&gt;GetZ() + <a class="code" href="../../d6/d2a/classKalmanFilter.html#ac3bc5f9249588956e1a6999e29bc2e7e">mNodeGapMax</a>;</div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;</div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;  <span class="comment">// Well, if there is no magnetic field inbetween, no sense </span></div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;  <span class="comment">// to introduce extra nodes; unless this is forced by respective </span></div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;  <span class="comment">// mode bit;</span></div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;  <span class="keywordflow">if</span> (mode &amp; _FILL_ALL_GAPS_ || knode-&gt;mNonLinearTransportFlags[<a class="code" href="../../d6/d2a/classKalmanFilter.html#a5592d57642d917049cd5df82ba5f1301a0ee44748271f2bf9a0c1e59671792ba0">KalmanFilter::Forward</a>] ||</div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;      knode-&gt;GetNext(<a class="code" href="../../d6/d2a/classKalmanFilter.html#a5592d57642d917049cd5df82ba5f1301a0ee44748271f2bf9a0c1e59671792ba0">KalmanFilter::Forward</a>)-&gt;mNonLinearTransportFlags[<a class="code" href="../../d6/d2a/classKalmanFilter.html#a5592d57642d917049cd5df82ba5f1301ab9d2e05c5574456f81aa222c76f0abe5">KalmanFilter::Backward</a>])</div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;  {</div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;    <span class="keywordflow">if</span> (zz &lt; knode-&gt;GetNext(<a class="code" href="../../d6/d2a/classKalmanFilter.html#a5592d57642d917049cd5df82ba5f1301a0ee44748271f2bf9a0c1e59671792ba0">KalmanFilter::Forward</a>)-&gt;GetZ() &amp;&amp; </div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;        !<a class="code" href="../../d6/d2a/classKalmanFilter.html#a8b30371bca3e6dc697ee6ec300c4af57">AddNodeWrapper</a>(NULL, format, zz, 0, NULL)) </div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;      <span class="keywordflow">return</span> -1; </div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;  } <span class="comment">/*if*/</span></div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;      } <span class="comment">/*if..for knode*/</span></div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;  }</div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;  <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;} <span class="comment">// KalmanFilter::Configure()</span></div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;</div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;<span class="comment">// ---------------------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;</div>
<div class="line"><a name="l00305"></a><span class="lineno"><a class="code" href="../../d6/d2a/classKalmanFilter.html#a1efe93e1ca814b9d90b7e981e13ea112">  305</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../d6/d2a/classKalmanFilter.html#a1efe93e1ca814b9d90b7e981e13ea112">KalmanFilter::ResetFiredFlags</a>()</div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;{</div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;  <span class="comment">// Consider to reset ALL node fired flags, even those who are not presently included </span></div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;  <span class="comment">// in the actually used double-linked list;</span></div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;  <span class="keywordflow">for</span>(std::map&lt;double, KalmanNode*&gt;::iterator <a class="code" href="../../d5/d0b/changehitformat_8cc.html#a592a0cf34c13b7b53e37c2791a6a982e">it</a>=<a class="code" href="../../d6/d2a/classKalmanFilter.html#a5b7f2f8bf70c38fbea402a7ebc07f280">mKalmanNodePool</a>.begin(); </div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;      <a class="code" href="../../d5/d0b/changehitformat_8cc.html#a592a0cf34c13b7b53e37c2791a6a982e">it</a> != <a class="code" href="../../d6/d2a/classKalmanFilter.html#a5b7f2f8bf70c38fbea402a7ebc07f280">mKalmanNodePool</a>.end(); <a class="code" href="../../d5/d0b/changehitformat_8cc.html#a592a0cf34c13b7b53e37c2791a6a982e">it</a>++) </div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;    <span class="comment">// FIXME: yes, for now do it by hand; group counters will be reset below; </span></div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;    <span class="comment">// see node-&gt;ResetFiredFlag() source code for more details;</span></div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;    <a class="code" href="../../d5/d0b/changehitformat_8cc.html#a592a0cf34c13b7b53e37c2791a6a982e">it</a>-&gt;second-&gt;mFired = <span class="keyword">false</span>; </div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;</div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;  <span class="comment">// Reset group fired counters;</span></div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;  <span class="keywordflow">for</span>(<a class="code" href="../../d1/d50/classNodeGroup.html">NodeGroup</a> *group=<a class="code" href="../../d6/d2a/classKalmanFilter.html#afb318b6582f705dbf02fd79005e125b2">mNodeGroups</a>; group; group=group-&gt;<a class="code" href="../../d1/d50/classNodeGroup.html#a06b36a722306b8020115bcb6f8d501c7">mNextGroup</a>)</div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;    group-&gt;mFiredNodeNum = group-&gt;mNdfControlFlag = 0;  </div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;} <span class="comment">// KalmanFilter::ResetFiredFlags() </span></div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;</div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;<span class="comment">// ---------------------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;</div>
<div class="line"><a name="l00322"></a><span class="lineno"><a class="code" href="../../d6/d2a/classKalmanFilter.html#a1157e070c3aab64ed471d0458419264f">  322</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../d6/d2a/classKalmanFilter.html#a1157e070c3aab64ed471d0458419264f">KalmanFilter::LatchGroupNdfControlFlags</a>()</div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;{</div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;  <span class="keywordflow">for</span>(<a class="code" href="../../d1/d50/classNodeGroup.html">NodeGroup</a> *group=<a class="code" href="../../d6/d2a/classKalmanFilter.html#afb318b6582f705dbf02fd79005e125b2">mNodeGroups</a>; group; group=group-&gt;<a class="code" href="../../d1/d50/classNodeGroup.html#a06b36a722306b8020115bcb6f8d501c7">mNextGroup</a>) </div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;    <span class="keywordflow">if</span> (group-&gt;mFiredNodeNum) group-&gt;mNdfControlFlag = 1;</div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;} <span class="comment">// KalmanFilter::LatchGroupNdfControlFlags()</span></div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;</div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;<span class="comment">// ---------------------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;</div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;<span class="comment">//  FIXME: this hack indeed assumes a single global node group;</span></div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;</div>
<div class="line"><a name="l00334"></a><span class="lineno"><a class="code" href="../../d6/d2a/classKalmanFilter.html#a182964a2032f4a5e1f079a54d39c1594">  334</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../d6/d2a/classKalmanFilter.html#a182964a2032f4a5e1f079a54d39c1594">KalmanFilter::HackGroupHitCountLimit</a>(<span class="keywordtype">unsigned</span> <a class="code" href="../../dc/d49/HelixHough__allButKappaRange__sse_8cpp.html#a4735a0c4d1b11f62ea44115d54a93087">min</a>)</div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;{</div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;  <span class="keywordflow">for</span>(<a class="code" href="../../d1/d50/classNodeGroup.html">NodeGroup</a> *group=<a class="code" href="../../d6/d2a/classKalmanFilter.html#afb318b6582f705dbf02fd79005e125b2">mNodeGroups</a>; group; group=group-&gt;<a class="code" href="../../d1/d50/classNodeGroup.html#a06b36a722306b8020115bcb6f8d501c7">mNextGroup</a>) </div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;    group-&gt;mFiredNodeNumMin = min;</div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;} <span class="comment">// KalmanFilter::HackGroupHitCountLimit()</span></div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;</div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;<span class="comment">// =======================================================================================</span></div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;</div>
<div class="line"><a name="l00342"></a><span class="lineno"><a class="code" href="../../d6/d2a/classKalmanFilter.html#a3dc79ff2ca154297d6d86f3dee8f0194">  342</a></span>&#160;<span class="keywordtype">unsigned</span> <a class="code" href="../../d6/d2a/classKalmanFilter.html#a3dc79ff2ca154297d6d86f3dee8f0194">KalmanFilter::FilterPass</a>(<a class="code" href="../../de/ddb/classKalmanNode.html">KalmanNode</a> *<a class="code" href="../../dc/de5/PHG4mRICHDetector_8cc.html#a10e6010f5f8222befd1273192d72ddf5">start</a>, <a class="code" href="../../de/ddb/classKalmanNode.html">KalmanNode</a> *end, <a class="code" href="../../d6/d2a/classKalmanFilter.html#a5592d57642d917049cd5df82ba5f1301">KalmanFilter::Direction</a> fb)</div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;{</div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;  <span class="keywordtype">int</span> ret;</div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;  <span class="comment">// If &#39;start&#39; pointer is specified, use it; otherwise take head/tail; </span></div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;  <a class="code" href="../../de/ddb/classKalmanNode.html">KalmanNode</a> *snode = start ? start : (fb == <a class="code" href="../../d6/d2a/classKalmanFilter.html#a5592d57642d917049cd5df82ba5f1301a0ee44748271f2bf9a0c1e59671792ba0">KalmanFilter::Forward</a> ? <a class="code" href="../../d6/d2a/classKalmanFilter.html#aac222f7c48aa36a619f3e81c9a1eae1d">mHead</a> : <a class="code" href="../../d6/d2a/classKalmanFilter.html#a1ac7f3cfd1048e7552604e87a2ecf371">mTail</a>);</div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;</div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;  <a class="code" href="../../d6/d2a/classKalmanFilter.html#a7b48f0a8dda44643d86004065d9d6d96">mLastFilterPass</a> = <a class="code" href="../../d6/d2a/classKalmanFilter.html#a5592d57642d917049cd5df82ba5f1301a2d4913d81db3e15a46103a44ca890eb8">KalmanFilter::Undefined</a>;</div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;</div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;  <span class="comment">// Save start/end node pointers for the (possible) smoother pass; </span></div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;  <a class="code" href="../../d6/d2a/classKalmanFilter.html#a31b0db5559d7b3bd91dd02edd244a0c7">mLastStart</a> = snode;</div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;  <a class="code" href="../../d6/d2a/classKalmanFilter.html#a1789602af0adf99b603e2f3ec9208afc">mLastEnd</a>   = end ? end : (fb == <a class="code" href="../../d6/d2a/classKalmanFilter.html#a5592d57642d917049cd5df82ba5f1301a0ee44748271f2bf9a0c1e59671792ba0">KalmanFilter::Forward</a> ? <a class="code" href="../../d6/d2a/classKalmanFilter.html#a1ac7f3cfd1048e7552604e87a2ecf371">mTail</a> : <a class="code" href="../../d6/d2a/classKalmanFilter.html#aac222f7c48aa36a619f3e81c9a1eae1d">mHead</a>);</div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;</div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;  <span class="comment">// Calculate x0[], FR[][], Q[][] for all requested nodes; NB: it is </span></div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;  <span class="comment">// however assumed that snode-&gt;x0[] is given correctly;</span></div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;  <span class="keywordflow">if</span> ((ret = <a class="code" href="../../d6/d2a/classKalmanFilter.html#a55ddbff3b818a05898149dd51313047a">Calculate_x0_FR_Q</a>(snode, end, fb, </div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;             <a class="code" href="../../dc/db1/KalmanFilter_8h.html#a4f51175547eaeb6e749d7ba3a9aeeec6">_CALCULATE_DERIVATIVES_</a>|<a class="code" href="../../dc/db1/KalmanFilter_8h.html#a3f027fc9b154da4e22bc9fc0c9aad2a4">_CALCULATE_PROCESS_NOISE_</a>))) </div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;    <span class="keywordflow">return</span> ret; </div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;</div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;  <span class="comment">// Do Kalman filter matrix calculations;</span></div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;  <span class="keywordflow">if</span> ((ret = <a class="code" href="../../d6/d2a/classKalmanFilter.html#a45d7662a8e30d56baa92e9eb43967128">DoFilterAlgebra</a>(snode, end, fb))) <span class="keywordflow">return</span> ret; </div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;</div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;  <span class="comment">// Make smoother aware of the filter arrays status; </span></div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;  <a class="code" href="../../d6/d2a/classKalmanFilter.html#a7b48f0a8dda44643d86004065d9d6d96">mLastFilterPass</a> = fb;</div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;</div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;  <a class="code" href="../../d6/d2a/classKalmanFilter.html#abb88864f4aa74aa6f35657345ee7f268">CalculateFilterStat</a>();</div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;</div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;  <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;} <span class="comment">// KalmanFilter::FilterPass()</span></div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;</div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;<span class="comment">// ---------------------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;</div>
<div class="line"><a name="l00373"></a><span class="lineno"><a class="code" href="../../d6/d2a/classKalmanFilter.html#a55ddbff3b818a05898149dd51313047a">  373</a></span>&#160;<span class="keywordtype">unsigned</span> <a class="code" href="../../d6/d2a/classKalmanFilter.html#a55ddbff3b818a05898149dd51313047a">KalmanFilter::Calculate_x0_FR_Q</a>(<a class="code" href="../../de/ddb/classKalmanNode.html">KalmanNode</a> *<a class="code" href="../../dc/de5/PHG4mRICHDetector_8cc.html#a10e6010f5f8222befd1273192d72ddf5">start</a>, <a class="code" href="../../de/ddb/classKalmanNode.html">KalmanNode</a> *end, </div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;           <a class="code" href="../../d6/d2a/classKalmanFilter.html#a5592d57642d917049cd5df82ba5f1301">KalmanFilter::Direction</a> fb, <span class="keywordtype">unsigned</span> mode)</div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;{                   </div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;  <span class="keywordflow">for</span>(<a class="code" href="../../de/ddb/classKalmanNode.html">KalmanNode</a> *node=start; node; node=node-&gt;<a class="code" href="../../de/ddb/classKalmanNode.html#a065c3feb4f0dd3ab087924a68444ae44">GetNext</a>(fb)) {           </div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;    <span class="keywordflow">if</span> (node != start) {           </div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;      <a class="code" href="../../de/ddb/classKalmanNode.html">KalmanNode</a> *from = node-&gt;<a class="code" href="../../de/ddb/classKalmanNode.html#ace97160fe980b0cc8b6d037acf175bae">GetPrev</a>(fb);</div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;</div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;      <span class="comment">// Extrapolate x0[]; depends on the transport non-linearity </span></div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;      <span class="comment">// (magnetic field presence in tracking case);</span></div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;      <span class="keywordflow">if</span> (node-&gt;GetZ() == from-&gt;<a class="code" href="../../de/ddb/classKalmanNode.html#a11c38d56a7945d0464475581b83c5632">GetZ</a>()) {</div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;  node-&gt;<a class="code" href="../../de/ddb/classKalmanNode.html#aaa4c7a874cff9bdbc67db4506f0ad033">x0</a>-&gt;<a class="code" href="../../da/dd0/classKfMatrix.html#ab490f06861e719f20e49f4d758abbae4">CopyFrom</a>(from-&gt;<a class="code" href="../../de/ddb/classKalmanNode.html#aaa4c7a874cff9bdbc67db4506f0ad033">x0</a>);</div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;</div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;  from-&gt;<a class="code" href="../../de/ddb/classKalmanNode.html#a0b160ede1079f6cf43a18ecea61055a2">FR</a> = <a class="code" href="../../d6/d2a/classKalmanFilter.html#a35114b016772134102611c1eef19edea">SU</a>; </div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;      }</div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;      <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;  <span class="keywordflow">if</span> (node-&gt;mNonLinearTransportFlags[(fb+1)%2] || </div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;      from-&gt;<a class="code" href="../../de/ddb/classKalmanNode.html#abacedb8b2f6d0b425f9640d88273609a">mNonLinearTransportFlags</a>[ fb     ]) {</div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2a/classKalmanFilter.html#ab91ffb8e9d22449dc3f3e0ef754653f2">Transport</a>(from, fb, mode)) </div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;      <a class="code" href="../../d7/ddf/htclib_8h.html#a3cf74af3f9d9115ac8963ee8f38ea812">_RETURN_</a>(<a class="code" href="../../dc/db1/KalmanFilter_8h.html#af06381a561d7038da27f8ebc05ee241f">_TFUN_FAILURE_</a>, <span class="stringliteral">&quot;Filter failed in root-&gt;transport()!\n&quot;</span>);</div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;    </div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;    from-&gt;<a class="code" href="../../de/ddb/classKalmanNode.html#a0b160ede1079f6cf43a18ecea61055a2">FR</a> = from-&gt;<a class="code" href="../../de/ddb/classKalmanNode.html#a787a78a59e8e8d92f1877acefc6cf3f4">FM</a>;</div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;  }</div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;  <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;    <span class="comment">// Just use pre-calculated FF[][]-matrix for the pure linear case;</span></div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;    node-&gt;x0-&gt;<a class="code" href="../../da/dd0/classKfMatrix.html#a89d6b58b2efee54f0b3be78dd0ea188b">SetToProduct</a>(from-&gt;<a class="code" href="../../de/ddb/classKalmanNode.html#a30e26e060dea255df259e1ab69105a0e">FF</a>[fb], from-&gt;<a class="code" href="../../de/ddb/classKalmanNode.html#aaa4c7a874cff9bdbc67db4506f0ad033">x0</a>);</div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;    </div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;    <span class="comment">//assert(0);</span></div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;    from-&gt;<a class="code" href="../../de/ddb/classKalmanNode.html#a0b160ede1079f6cf43a18ecea61055a2">FR</a> = from-&gt;<a class="code" href="../../de/ddb/classKalmanNode.html#a30e26e060dea255df259e1ab69105a0e">FF</a>[fb]; </div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;  } <span class="comment">//if</span></div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;      } <span class="comment">//if</span></div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;</div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;      <span class="comment">// There may be extra stuff, application-specific (say, multiple scattering </span></div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;      <span class="comment">// calculation in case of tracking Kalman Filter;</span></div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2a/classKalmanFilter.html#a8244f47d28f3beedfffc2ec59e744614">TransportExtra</a>(from, fb, mode)) </div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;    <a class="code" href="../../d7/ddf/htclib_8h.html#a3cf74af3f9d9115ac8963ee8f38ea812">_RETURN_</a>(<a class="code" href="../../dc/db1/KalmanFilter_8h.html#a211ac4b780c2ac8da0209f4bc333c316">_NFUN_FAILURE_</a>, <span class="stringliteral">&quot;Filter failed in root-&gt;extra()!\n&quot;</span>);</div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;    } <span class="comment">//if</span></div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;</div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;    <span class="keywordflow">if</span> (end &amp;&amp; node == end) <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;  } <span class="comment">//for node</span></div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;</div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;  <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;} <span class="comment">// KalmanFilter::Calculate_x0_FR_Q() </span></div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;</div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;<span class="comment">// ---------------------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;</div>
<div class="line"><a name="l00418"></a><span class="lineno"><a class="code" href="../../d6/d2a/classKalmanFilter.html#a45d7662a8e30d56baa92e9eb43967128">  418</a></span>&#160;<span class="keywordtype">unsigned</span> <a class="code" href="../../d6/d2a/classKalmanFilter.html#a45d7662a8e30d56baa92e9eb43967128">KalmanFilter::DoFilterAlgebra</a>(<a class="code" href="../../de/ddb/classKalmanNode.html">KalmanNode</a> *<a class="code" href="../../dc/de5/PHG4mRICHDetector_8cc.html#a10e6010f5f8222befd1273192d72ddf5">start</a>, <a class="code" href="../../de/ddb/classKalmanNode.html">KalmanNode</a> *end, </div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;               <a class="code" href="../../d6/d2a/classKalmanFilter.html#a5592d57642d917049cd5df82ba5f1301">KalmanFilter::Direction</a> fb) </div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;{                      </div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;  <span class="comment">// Calculate everything (but tnode-&gt;x0[]) in one pass; </span></div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;  <span class="keywordflow">for</span>(<a class="code" href="../../de/ddb/classKalmanNode.html">KalmanNode</a> *node=start; node; node=node-&gt;<a class="code" href="../../de/ddb/classKalmanNode.html#a065c3feb4f0dd3ab087924a68444ae44">GetNext</a>(fb)) {         </div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;    <span class="comment">// All the stuff which makes sense only if there were </span></div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;    <span class="comment">// calculated nodes before in the chain;     </span></div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;    <span class="keywordflow">if</span> (node != start) {</div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;      <a class="code" href="../../de/ddb/classKalmanNode.html">KalmanNode</a> *from = node-&gt;<a class="code" href="../../de/ddb/classKalmanNode.html#ace97160fe980b0cc8b6d037acf175bae">GetPrev</a>(fb);</div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;</div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;      node-&gt;<a class="code" href="../../de/ddb/classKalmanNode.html#a60ddedbf6496af4353d4e563a4bbf52f">xp</a>-&gt;<a class="code" href="../../da/dd0/classKfMatrix.html#a89d6b58b2efee54f0b3be78dd0ea188b">SetToProduct</a>(from-&gt;<a class="code" href="../../de/ddb/classKalmanNode.html#a0b160ede1079f6cf43a18ecea61055a2">FR</a>, from-&gt;<a class="code" href="../../de/ddb/classKalmanNode.html#a53df45543518d8c83de7ef5ecef0213e">xf</a>);</div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;</div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;      node-&gt;CP-&gt;SetToProduct(from-&gt;<a class="code" href="../../de/ddb/classKalmanNode.html#a0b160ede1079f6cf43a18ecea61055a2">FR</a>, from-&gt;<a class="code" href="../../de/ddb/classKalmanNode.html#aa0654e2b24f24429c8ed3aa6e388ae62">CF</a>, from-&gt;<a class="code" href="../../de/ddb/classKalmanNode.html#a0b160ede1079f6cf43a18ecea61055a2">FR</a>, <a class="code" href="../../d5/d12/KfMatrix_8h.html#ac7d936564d7b5fefa168706af5932d3e">_TRANSPOSE_IN3_</a>);</div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;</div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;      node-&gt;CP-&gt;Add(from-&gt;<a class="code" href="../../de/ddb/classKalmanNode.html#ab559515caeae393602704c90ddf33957">Q</a>);</div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;</div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2a/classKalmanFilter.html#aeb0ed86093c9541a7b9a3d0ff6ba2617">mPositivityCheck</a> &amp;&amp; node-&gt;CP-&gt;CheckPositivity())</div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;  <a class="code" href="../../dc/db1/KalmanFilter_8h.html#a50621379a5bea7702bce41fb1eb509e3">_KF_RETURN_</a>(<a class="code" href="../../dc/db1/KalmanFilter_8h.html#abfa3782f9a0716f8b2a73f9603e4f9cc">_DSINV_FAILURE_</a>, </div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;        <span class="stringliteral">&quot;node-&gt;CP is not positive-definite (filter)!\n&quot;</span>, <a class="code" href="../../d6/d2a/classKalmanFilter.html#a51d93c6451f96b52a3681287b8ae2dadaf0e967b6e9a622677e42818f3da52f74">KalmanFilter::Error</a>);</div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2a/classKalmanFilter.html#ac37d594f0e018efd90014a92c89cc151">mForceSymmetrization</a>) node-&gt;CP-&gt;ForceSymmetric();</div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;    } <span class="comment">//if</span></div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;</div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;    <span class="comment">// If node was fired (has it&#39;s own valuable measurement), </span></div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;    <span class="comment">// usual Kalman technique is applied;</span></div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;    <span class="keywordflow">if</span> (node-&gt;mFired) {</div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;      <span class="comment">// Calculate H-matrix (and perhaps m[]) if root-&gt;hfun() != NULL;</span></div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;      <span class="comment">// yes, it looks like this is needed for fired nodes only;</span></div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2a/classKalmanFilter.html#a4e247bbdaff4fb3f80606adb167d4be0">CalculateHMatrix</a>(node)) </div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;  <a class="code" href="../../d7/ddf/htclib_8h.html#a3cf74af3f9d9115ac8963ee8f38ea812">_RETURN_</a>(<a class="code" href="../../dc/db1/KalmanFilter_8h.html#a7ac040c0b0bd1137d5356397744348b8">_HFUN_FAILURE_</a>, <span class="stringliteral">&quot;Filter failed in node-&gt;hfun()!\n&quot;</span>);</div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;</div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;      <span class="comment">// Prediction cov.matrix and Kalman gain matrix calculation;</span></div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;      node-&gt;MMTX-&gt;SetToProduct(node-&gt;H, node-&gt;CP, node-&gt;H, <a class="code" href="../../d5/d12/KfMatrix_8h.html#ac7d936564d7b5fefa168706af5932d3e">_TRANSPOSE_IN3_</a>);</div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;      node-&gt;RPI-&gt;SetToSum(node-&gt;MMTX, node-&gt;V); </div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2a/classKalmanFilter.html#ac37d594f0e018efd90014a92c89cc151">mForceSymmetrization</a>) node-&gt;RPI-&gt;ForceSymmetric();</div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;      <span class="keywordflow">if</span> (node-&gt;RPI-&gt;Invert(<a class="code" href="../../da/dd0/classKfMatrix.html#af15e721b5d8b0758011c193999ac3140a69cbca4a8e8cf9d2ad4596c4c4d05d79">KfMatrix::Symmetric</a>)) </div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;  <a class="code" href="../../d7/ddf/htclib_8h.html#a3cf74af3f9d9115ac8963ee8f38ea812">_RETURN_</a>(<a class="code" href="../../dc/db1/KalmanFilter_8h.html#abfa3782f9a0716f8b2a73f9603e4f9cc">_DSINV_FAILURE_</a>, <span class="stringliteral">&quot;DSINV() failed (filter) #1!\n&quot;</span>);</div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;      node-&gt;K-&gt;SetToProduct(node-&gt;CP, node-&gt;H, node-&gt;RPI, <a class="code" href="../../d5/d12/KfMatrix_8h.html#abf594a74c6af66ae70d6c6cae48e0ae0">_TRANSPOSE_IN2_</a>);</div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;</div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;      <span class="comment">// Prediction error; state vector update; </span></div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;      node-&gt;ep-&gt;SetToProduct(node-&gt;H, node-&gt;xp);</div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;      node-&gt;ep-&gt;SetToDifference(node-&gt;m, node-&gt;ep);</div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;      <a class="code" href="../../d6/d2a/classKalmanFilter.html#a72a17d3b2c3b2a81ab080676aa9d5060">SVEC</a>-&gt;<a class="code" href="../../da/dd0/classKfMatrix.html#a89d6b58b2efee54f0b3be78dd0ea188b">SetToProduct</a>(node-&gt;K, node-&gt;ep);</div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;      node-&gt;xf-&gt;SetToSum(node-&gt;xp, <a class="code" href="../../d6/d2a/classKalmanFilter.html#a72a17d3b2c3b2a81ab080676aa9d5060">SVEC</a>);</div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;</div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;      <span class="comment">// Filtered covariance matrix update; since now use De Jong smoother </span></div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;      <span class="comment">// formalism, which requires &quot;I-KH&quot; matrix anyway, makes sense to </span></div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;      <span class="comment">// introduce it as intermediate LB[][] matrix right here;</span></div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;      <a class="code" href="../../d6/d2a/classKalmanFilter.html#a7c6a6b91058b6efa517098c2cd38b862">SMTX</a>-&gt;<a class="code" href="../../da/dd0/classKfMatrix.html#a89d6b58b2efee54f0b3be78dd0ea188b">SetToProduct</a>(node-&gt;K, node-&gt;H);</div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;      node-&gt;LB-&gt;SetToDifference(<a class="code" href="../../d6/d2a/classKalmanFilter.html#a35114b016772134102611c1eef19edea">SU</a>, <a class="code" href="../../d6/d2a/classKalmanFilter.html#a7c6a6b91058b6efa517098c2cd38b862">SMTX</a>);</div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;      node-&gt;CF-&gt;SetToProduct(node-&gt;LB, node-&gt;CP, node-&gt;LB, <a class="code" href="../../d5/d12/KfMatrix_8h.html#ac7d936564d7b5fefa168706af5932d3e">_TRANSPOSE_IN3_</a>);</div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;      <a class="code" href="../../d6/d2a/classKalmanFilter.html#a7c6a6b91058b6efa517098c2cd38b862">SMTX</a>-&gt;<a class="code" href="../../da/dd0/classKfMatrix.html#a89d6b58b2efee54f0b3be78dd0ea188b">SetToProduct</a>(node-&gt;K, node-&gt;V, node-&gt;K, <a class="code" href="../../d5/d12/KfMatrix_8h.html#ac7d936564d7b5fefa168706af5932d3e">_TRANSPOSE_IN3_</a>);</div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;      node-&gt;CF-&gt;Add(<a class="code" href="../../d6/d2a/classKalmanFilter.html#a7c6a6b91058b6efa517098c2cd38b862">SMTX</a>);</div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2a/classKalmanFilter.html#aeb0ed86093c9541a7b9a3d0ff6ba2617">mPositivityCheck</a> &amp;&amp; node-&gt;CF-&gt;CheckPositivity())</div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;  <a class="code" href="../../dc/db1/KalmanFilter_8h.html#a50621379a5bea7702bce41fb1eb509e3">_KF_RETURN_</a>(<a class="code" href="../../dc/db1/KalmanFilter_8h.html#abfa3782f9a0716f8b2a73f9603e4f9cc">_DSINV_FAILURE_</a>, </div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;        <span class="stringliteral">&quot;node-&gt;CF is not positive-definite (filter)!\n&quot;</span>, <a class="code" href="../../d6/d2a/classKalmanFilter.html#a51d93c6451f96b52a3681287b8ae2dadaf0e967b6e9a622677e42818f3da52f74">KalmanFilter::Error</a>);</div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2a/classKalmanFilter.html#ac37d594f0e018efd90014a92c89cc151">mForceSymmetrization</a>) node-&gt;CF-&gt;ForceSymmetric();</div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;</div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;      <span class="comment">// The rest in principle makes sense if only there were already sufficient </span></div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;      <span class="comment">// fired nodes passed before; there is however a complication that say for </span></div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;      <span class="comment">// non-fixed-momentum tracking and weak fringe field 5-th fired node can be </span></div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;      <span class="comment">// still out of strong field, so mNdf&gt;0 check is perhaps not the best criterion; </span></div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;      <span class="comment">// since these days node-&gt;chi2_filter_increment is actually used to calculate </span></div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;      <span class="comment">// overall filter pass chi^2 sum (and not to determine outlier</span></div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;      <span class="comment">// nodes), one can simply set a cut on RF[0][0] (assuming </span></div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;      <span class="comment">// mdim=1) and forget about the problem;   </span></div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;      {</div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;  <span class="comment">// Covariance matrix of filtered residuals; </span></div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;  node-&gt;RF-&gt;SetToProduct(node-&gt;H, node-&gt;CF, node-&gt;H, <a class="code" href="../../d5/d12/KfMatrix_8h.html#ac7d936564d7b5fefa168706af5932d3e">_TRANSPOSE_IN3_</a>);</div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;  node-&gt;RF-&gt;SetToDifference(node-&gt;V, node-&gt;RF);</div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2a/classKalmanFilter.html#ac37d594f0e018efd90014a92c89cc151">mForceSymmetrization</a>) node-&gt;RF-&gt;ForceSymmetric();</div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;</div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;  <span class="keywordtype">bool</span> ok = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;</div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;  <span class="comment">// Check that there are no &quot;too small&quot; cov.matrix diagonal elements;</span></div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;  <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> iq=0; iq&lt;node-&gt;GetMdim(); iq++) </div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;    <span class="keywordflow">if</span> (node-&gt;RF-&gt;KFM(0,0) &lt;= <a class="code" href="../../d6/d2a/classKalmanFilter.html#afcb3fe5f3e6ba32e49e89a9468d64169">mRFCutoffValue</a>) {</div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;      ok = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;      <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;    } <span class="comment">//for iq..if </span></div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;</div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;  <span class="keywordflow">if</span> (ok) {</div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;    <span class="comment">// Filtered residuals; </span></div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;    node-&gt;rf-&gt;SetToProduct(node-&gt;H, node-&gt;xf);</div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;    node-&gt;rf-&gt;SetToDifference(node-&gt;m, node-&gt;rf);</div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;</div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;    <span class="comment">// Calculate chi^2 stuff; </span></div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;    node-&gt;MMTX-&gt;CopyFrom(node-&gt;RF);</div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;    <span class="keywordflow">if</span> (node-&gt;MMTX-&gt;Invert(<a class="code" href="../../da/dd0/classKfMatrix.html#af15e721b5d8b0758011c193999ac3140a69cbca4a8e8cf9d2ad4596c4c4d05d79">KfMatrix::Symmetric</a>)) </div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;      <a class="code" href="../../dc/db1/KalmanFilter_8h.html#a50621379a5bea7702bce41fb1eb509e3">_KF_RETURN_</a>(<a class="code" href="../../dc/db1/KalmanFilter_8h.html#abfa3782f9a0716f8b2a73f9603e4f9cc">_DSINV_FAILURE_</a>, <span class="stringliteral">&quot;DSINV() failed (filter) #2!\n&quot;</span>, <a class="code" href="../../d6/d2a/classKalmanFilter.html#a51d93c6451f96b52a3681287b8ae2dadaf0e967b6e9a622677e42818f3da52f74">KalmanFilter::Error</a>);</div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;    node-&gt;rf-&gt;VectorLengthSquare(node-&gt;MMTX, &amp;node-&gt;mFilterChiSquareIncrement);</div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;  }</div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;  <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;    node-&gt;rf-&gt;Reset();</div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;    node-&gt;mFilterChiSquareIncrement = 0.;</div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;  } <span class="comment">//if</span></div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;      }</div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;    } </div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;    {</div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;      <span class="comment">// Yes, just predicted values in this case;</span></div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;      node-&gt;xf-&gt;CopyFrom(node-&gt;xp);</div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;      node-&gt;CF-&gt;CopyFrom(node-&gt;CP);</div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;</div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;      <span class="comment">// Effectively this means that Kalman gain is 0;</span></div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;      node-&gt;LB-&gt;Unity();</div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;    } <span class="comment">//if</span></div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;</div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;    <span class="keywordflow">if</span> (end &amp;&amp; node == end) <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;  } <span class="comment">//for node</span></div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;</div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;  <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;} <span class="comment">// KalmanFilter::DoFilterAlgebra()</span></div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;</div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;<span class="comment">// ---------------------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;</div>
<div class="line"><a name="l00533"></a><span class="lineno"><a class="code" href="../../d6/d2a/classKalmanFilter.html#abb88864f4aa74aa6f35657345ee7f268">  533</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="../../d6/d2a/classKalmanFilter.html#abb88864f4aa74aa6f35657345ee7f268">KalmanFilter::CalculateFilterStat</a>()</div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;{                      </div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2a/classKalmanFilter.html#a7b48f0a8dda44643d86004065d9d6d96">mLastFilterPass</a> == <a class="code" href="../../d6/d2a/classKalmanFilter.html#a5592d57642d917049cd5df82ba5f1301a2d4913d81db3e15a46103a44ca890eb8">KalmanFilter::Undefined</a>) <span class="keywordflow">return</span> -1;</div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;</div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;  <a class="code" href="../../d6/d2a/classKalmanFilter.html#aeb5d6ab574df6feba9cfb33eb7dbd862">mFilterChiSquare</a> = 0.; <a class="code" href="../../d6/d2a/classKalmanFilter.html#a84cd00847056c70efc60fe54a18d685b">mNdf</a> = -<a class="code" href="../../d6/d2a/classKalmanFilter.html#a06c2cdbf11c690bc94d7efccdf7b5b93">sDim</a> + <a class="code" href="../../d6/d2a/classKalmanFilter.html#aff5ead10f0af7a83997c0bf466903b32">mExtraNdfCount</a>;</div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;</div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;  <span class="keywordflow">for</span>(<a class="code" href="../../de/ddb/classKalmanNode.html">KalmanNode</a> *node=<a class="code" href="../../d6/d2a/classKalmanFilter.html#a31b0db5559d7b3bd91dd02edd244a0c7">mLastStart</a>; node; node=node-&gt;<a class="code" href="../../de/ddb/classKalmanNode.html#a065c3feb4f0dd3ab087924a68444ae44">GetNext</a>(<a class="code" href="../../d6/d2a/classKalmanFilter.html#a7b48f0a8dda44643d86004065d9d6d96">mLastFilterPass</a>)) {</div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;    <span class="keywordflow">if</span> (node-&gt;mFired) {</div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;      <span class="comment">// Ok, this is clear; fix 2009/09/25; fired _PIXEL_ node</span></div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;      <span class="comment">// for instance will increment ndf by 2;</span></div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;      <a class="code" href="../../d6/d2a/classKalmanFilter.html#a84cd00847056c70efc60fe54a18d685b">mNdf</a> += node-&gt;mDim;</div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;</div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;      <span class="comment">//printf(&quot;%s %f -&gt; %f\n&quot;, node-&gt;GetName(), node-&gt;GetZ(), node-&gt;mFilterChiSquareIncrement);</span></div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;      <a class="code" href="../../d6/d2a/classKalmanFilter.html#aeb5d6ab574df6feba9cfb33eb7dbd862">mFilterChiSquare</a> += node-&gt;mFilterChiSquareIncrement;</div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;    } <span class="comment">//if</span></div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;</div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;    <span class="keywordflow">if</span> (node == <a class="code" href="../../d6/d2a/classKalmanFilter.html#a1789602af0adf99b603e2f3ec9208afc">mLastEnd</a>) <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;  } <span class="comment">//for node</span></div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;  <span class="comment">//exit(0);</span></div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;</div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;  <span class="comment">// Prefer to always calculate this value;</span></div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;  <a class="code" href="../../d6/d2a/classKalmanFilter.html#ac08d0ab4bba617db8428a1a3ef030725">mFilterChiSquareCCDF</a> = <a class="code" href="../../d6/d2a/classKalmanFilter.html#a84cd00847056c70efc60fe54a18d685b">mNdf</a> &gt; 0 ? ROOT::Math::chisquared_cdf_c(<a class="code" href="../../d6/d2a/classKalmanFilter.html#aeb5d6ab574df6feba9cfb33eb7dbd862">mFilterChiSquare</a>, <a class="code" href="../../d6/d2a/classKalmanFilter.html#a84cd00847056c70efc60fe54a18d685b">mNdf</a>) : 0.;</div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;</div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;  <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;} <span class="comment">// KalmanFilter::CalculateFilterStat()</span></div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;</div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;<span class="comment">// =======================================================================================</span></div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;</div>
<div class="line"><a name="l00561"></a><span class="lineno"><a class="code" href="../../d6/d2a/classKalmanFilter.html#a71cf5c851023da4b228e3654cca58928">  561</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="../../d6/d2a/classKalmanFilter.html#a71cf5c851023da4b228e3654cca58928">KalmanFilter::SmootherPass</a>()</div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;{</div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;  <span class="comment">// This variable determines *smoother* direction; NB: it is per definition </span></div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;  <span class="comment">// opposite to the filter direction which is supposed to be ran before;</span></div>
<div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;  <span class="comment">// and indeed smoother starts at the node where filter finished its work;</span></div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;  <span class="keywordtype">int</span> fb;</div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;</div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;  <span class="keywordflow">switch</span> (<a class="code" href="../../d6/d2a/classKalmanFilter.html#a7b48f0a8dda44643d86004065d9d6d96">mLastFilterPass</a>) {</div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;    <span class="comment">// Yes, just return _CHAIN_FAILURE_ here, who cares;</span></div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;  <span class="keywordflow">case</span> <a class="code" href="../../d6/d2a/classKalmanFilter.html#a5592d57642d917049cd5df82ba5f1301a2d4913d81db3e15a46103a44ca890eb8">KalmanFilter::Undefined</a>: </div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../dc/db1/KalmanFilter_8h.html#accf16f3c0da55ced651a48e682e670e3">_CHAIN_FAILURE_</a>;</div>
<div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;  <span class="keywordflow">case</span> <a class="code" href="../../d6/d2a/classKalmanFilter.html#a5592d57642d917049cd5df82ba5f1301a0ee44748271f2bf9a0c1e59671792ba0">KalmanFilter::Forward</a>:</div>
<div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;    fb = <a class="code" href="../../d6/d2a/classKalmanFilter.html#a5592d57642d917049cd5df82ba5f1301ab9d2e05c5574456f81aa222c76f0abe5">KalmanFilter::Backward</a>;</div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;  <span class="keywordflow">case</span> <a class="code" href="../../d6/d2a/classKalmanFilter.html#a5592d57642d917049cd5df82ba5f1301ab9d2e05c5574456f81aa222c76f0abe5">KalmanFilter::Backward</a>:</div>
<div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;    fb = <a class="code" href="../../d6/d2a/classKalmanFilter.html#a5592d57642d917049cd5df82ba5f1301a0ee44748271f2bf9a0c1e59671792ba0">KalmanFilter::Forward</a>;</div>
<div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;  <span class="keywordflow">default</span>:</div>
<div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;    assert(0);</div>
<div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;  } <span class="comment">//switch</span></div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;</div>
<div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;  <a class="code" href="../../d6/d2a/classKalmanFilter.html#acfbed2ec72e2a34ba2692e83aeb10593">mWorstSmootherNode</a> = <a class="code" href="../../d6/d2a/classKalmanFilter.html#aa19875e29a67684005c04871611bbbc7">mWorstResettableSmootherNode</a> = NULL;</div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;</div>
<div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;  <span class="comment">// Loop through all the start-end chain in [fb] direction;</span></div>
<div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;  <span class="keywordflow">for</span>(<a class="code" href="../../de/ddb/classKalmanNode.html">KalmanNode</a> *node=<a class="code" href="../../d6/d2a/classKalmanFilter.html#a1789602af0adf99b603e2f3ec9208afc">mLastEnd</a>; node; node=node-&gt;<a class="code" href="../../de/ddb/classKalmanNode.html#a065c3feb4f0dd3ab087924a68444ae44">GetNext</a>(fb)) {</div>
<div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;    <span class="comment">// This initialization is correct for root-&gt;mLastEnd node as well;</span></div>
<div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;    <span class="keywordflow">if</span> (node-&gt;mFired) {</div>
<div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;      node-&gt;<a class="code" href="../../de/ddb/classKalmanNode.html#a2113319a7cf579c21fa983218d4813c0">QQ</a>-&gt;<a class="code" href="../../da/dd0/classKfMatrix.html#a89d6b58b2efee54f0b3be78dd0ea188b">SetToProduct</a>(node-&gt;H, node-&gt;RPI, node-&gt;H, <a class="code" href="../../d5/d12/KfMatrix_8h.html#abe96f03ebc0ddf4726fc85940d56ca56">_TRANSPOSE_IN1_</a>);</div>
<div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2a/classKalmanFilter.html#ac37d594f0e018efd90014a92c89cc151">mForceSymmetrization</a>) node-&gt;QQ-&gt;ForceSymmetric();</div>
<div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;      node-&gt;qq-&gt;SetToProduct(node-&gt;H, node-&gt;RPI, node-&gt;ep, <a class="code" href="../../d5/d12/KfMatrix_8h.html#abe96f03ebc0ddf4726fc85940d56ca56">_TRANSPOSE_IN1_</a>);      </div>
<div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;    }</div>
<div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;    <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;      node-&gt;QQ-&gt;Reset();</div>
<div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;      node-&gt;qq-&gt;Reset();</div>
<div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;    } <span class="comment">//if</span></div>
<div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;</div>
<div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;    <span class="keywordflow">if</span> (node == <a class="code" href="../../d6/d2a/classKalmanFilter.html#a1789602af0adf99b603e2f3ec9208afc">mLastEnd</a>) {</div>
<div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;      node-&gt;CS-&gt;CopyFrom(node-&gt;CF);</div>
<div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;      node-&gt;xs-&gt;CopyFrom(node-&gt;xf);</div>
<div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;    }</div>
<div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;    <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;      <a class="code" href="../../de/ddb/classKalmanNode.html">KalmanNode</a> *prev = node-&gt;<a class="code" href="../../de/ddb/classKalmanNode.html#ace97160fe980b0cc8b6d037acf175bae">GetPrev</a>(fb);</div>
<div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;</div>
<div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;      <span class="comment">// Accomplish node-&gt;L[][] calculation; NB: do NOT follow original</span></div>
<div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;      <span class="comment">// Merkus-Pollock-Vos node counting scheme; namely calculate </span></div>
<div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;      <span class="comment">// L-matrix for CURRENT node, not for the PREVIOUS one; thus node-&gt;L</span></div>
<div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;      <span class="comment">// is used in the below formulae instead of prev-&gt;L;</span></div>
<div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;      node-&gt;<a class="code" href="../../de/ddb/classKalmanNode.html#ab9968b791e67084d95d862789853bb18">L</a>-&gt;<a class="code" href="../../da/dd0/classKfMatrix.html#a89d6b58b2efee54f0b3be78dd0ea188b">SetToProduct</a>(node-&gt;FR, node-&gt;LB);</div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;</div>
<div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;      <span class="comment">// Calculate smoothed covariance matrix; use De Jong formalism </span></div>
<div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;      <span class="comment">// (no smoother gain matrix usage), since it is indeed more </span></div>
<div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;      <span class="comment">// numerically stable (no CP-matrix inversion needed);</span></div>
<div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;      <a class="code" href="../../d6/d2a/classKalmanFilter.html#a7c6a6b91058b6efa517098c2cd38b862">SMTX</a>-&gt;<a class="code" href="../../da/dd0/classKfMatrix.html#a89d6b58b2efee54f0b3be78dd0ea188b">SetToProduct</a>(node-&gt;L, prev-&gt;<a class="code" href="../../de/ddb/classKalmanNode.html#a2113319a7cf579c21fa983218d4813c0">QQ</a>, node-&gt;L, <a class="code" href="../../d5/d12/KfMatrix_8h.html#abe96f03ebc0ddf4726fc85940d56ca56">_TRANSPOSE_IN1_</a>);</div>
<div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;      node-&gt;QQ-&gt;Add(<a class="code" href="../../d6/d2a/classKalmanFilter.html#a7c6a6b91058b6efa517098c2cd38b862">SMTX</a>);</div>
<div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2a/classKalmanFilter.html#ac37d594f0e018efd90014a92c89cc151">mForceSymmetrization</a>) node-&gt;QQ-&gt;ForceSymmetric();</div>
<div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;      <a class="code" href="../../d6/d2a/classKalmanFilter.html#a7c6a6b91058b6efa517098c2cd38b862">SMTX</a>-&gt;<a class="code" href="../../da/dd0/classKfMatrix.html#a89d6b58b2efee54f0b3be78dd0ea188b">SetToProduct</a>(node-&gt;CP, node-&gt;QQ, node-&gt;CP);</div>
<div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;      node-&gt;CS-&gt;SetToDifference(node-&gt;CP, <a class="code" href="../../d6/d2a/classKalmanFilter.html#a7c6a6b91058b6efa517098c2cd38b862">SMTX</a>);</div>
<div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2a/classKalmanFilter.html#aeb0ed86093c9541a7b9a3d0ff6ba2617">mPositivityCheck</a> &amp;&amp; node-&gt;CS-&gt;CheckPositivity()) {</div>
<div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;  <span class="comment">// Append positivity fix attempt to the overall mask;</span></div>
<div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;  <a class="code" href="../../d6/d2a/classKalmanFilter.html#a177718097efbebc2168d006ca607c4ac">mExtraReturnBits</a> |= <a class="code" href="../../dc/db1/KalmanFilter_8h.html#aef2edb50e1f67e63fdb3d271a44025bb">_POSITIVITY_FIX_</a>;</div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;</div>
<div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2a/classKalmanFilter.html#abe11dff14af0725ee55673ae51a45f43">mVerbosityLevel</a> &gt;= <a class="code" href="../../d6/d2a/classKalmanFilter.html#a51d93c6451f96b52a3681287b8ae2dadaf039328b3765a6b8d099ed1df3aea2e8">KalmanFilter::Warning</a>)</div>
<div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;CS[][] positivity check failed at Z=%7.2f\n&quot;</span>, node-&gt;GetZ());</div>
<div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;</div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;  <span class="comment">// Actually try to fix the problem; assume that if off-diagonal </span></div>
<div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;  <span class="comment">// correlation coefficients are a bit higher than 1.0 (happens </span></div>
<div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;  <span class="comment">// rarely for high-momenta tracks), this is caused by certain </span></div>
<div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;  <span class="comment">// numerical instability and is probably not that harmful; </span></div>
<div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;  <span class="comment">// if fail, return right here; NB: CheckPositivity() will </span></div>
<div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;  <span class="comment">// be called by positivity_fix() internally;</span></div>
<div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;  <span class="keywordflow">if</span> (node-&gt;CS-&gt;FixPositivity(<a class="code" href="../../d6/d2a/classKalmanFilter.html#affec4d56d4efba01b15b6a7910ff1115">mMaxFixablePositivityScrewup</a>, </div>
<div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;         <a class="code" href="../../d6/d2a/classKalmanFilter.html#a3939f3d7b5dfb4e1be546384241050a2">mPositivityCorrelationFix</a>)) {</div>
<div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2a/classKalmanFilter.html#abe11dff14af0725ee55673ae51a45f43">mVerbosityLevel</a> &gt;= <a class="code" href="../../d6/d2a/classKalmanFilter.html#a51d93c6451f96b52a3681287b8ae2dadaf0e967b6e9a622677e42818f3da52f74">KalmanFilter::Error</a>) {</div>
<div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;      node-&gt;CS-&gt;Print();</div>
<div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;      node-&gt;CS-&gt;CorrelationPrint();</div>
<div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;    } <span class="comment">//if</span></div>
<div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;</div>
<div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;    <a class="code" href="../../dc/db1/KalmanFilter_8h.html#a50621379a5bea7702bce41fb1eb509e3">_KF_RETURN_</a>(<a class="code" href="../../dc/db1/KalmanFilter_8h.html#abfa3782f9a0716f8b2a73f9603e4f9cc">_DSINV_FAILURE_</a>, </div>
<div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;          <span class="stringliteral">&quot;node-&gt;CS is not positive-definite (smoother)!\n&quot;</span>, <a class="code" href="../../d6/d2a/classKalmanFilter.html#a51d93c6451f96b52a3681287b8ae2dadaf0e967b6e9a622677e42818f3da52f74">KalmanFilter::Error</a>);</div>
<div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;  } <span class="comment">//if</span></div>
<div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;      } <span class="comment">//if</span></div>
<div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2a/classKalmanFilter.html#ac37d594f0e018efd90014a92c89cc151">mForceSymmetrization</a>) node-&gt;CS-&gt;ForceSymmetric();</div>
<div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;</div>
<div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;      <span class="comment">// Calculate smoothed state vector;</span></div>
<div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;      <a class="code" href="../../d6/d2a/classKalmanFilter.html#a72a17d3b2c3b2a81ab080676aa9d5060">SVEC</a>-&gt;<a class="code" href="../../da/dd0/classKfMatrix.html#a89d6b58b2efee54f0b3be78dd0ea188b">SetToProduct</a>(node-&gt;L, prev-&gt;<a class="code" href="../../de/ddb/classKalmanNode.html#a7399250c1c2e822b762d7a96c1a1cce0">qq</a>, <a class="code" href="../../d5/d12/KfMatrix_8h.html#abe96f03ebc0ddf4726fc85940d56ca56">_TRANSPOSE_IN1_</a>);</div>
<div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;      node-&gt;qq-&gt;Add(<a class="code" href="../../d6/d2a/classKalmanFilter.html#a72a17d3b2c3b2a81ab080676aa9d5060">SVEC</a>);</div>
<div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;      <a class="code" href="../../d6/d2a/classKalmanFilter.html#a72a17d3b2c3b2a81ab080676aa9d5060">SVEC</a>-&gt;<a class="code" href="../../da/dd0/classKfMatrix.html#a89d6b58b2efee54f0b3be78dd0ea188b">SetToProduct</a>(node-&gt;CP, node-&gt;qq);</div>
<div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;      node-&gt;xs-&gt;SetToSum(node-&gt;xp, <a class="code" href="../../d6/d2a/classKalmanFilter.html#a72a17d3b2c3b2a81ab080676aa9d5060">SVEC</a>);</div>
<div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;    } <span class="comment">//if</span></div>
<div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;</div>
<div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;    <span class="comment">// Perform xm[] calculation if needed; (12d) &amp; (12e) in original 1987 paper;</span></div>
<div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2a/classKalmanFilter.html#a38ef340602577d163cb984fa270b0cae">mXmCalculationFlag</a>) {</div>
<div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;      node-&gt;CM-&gt;CopyFrom(node-&gt;CS);</div>
<div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;      node-&gt;CM-&gt;Invert(<a class="code" href="../../da/dd0/classKfMatrix.html#af15e721b5d8b0758011c193999ac3140a69cbca4a8e8cf9d2ad4596c4c4d05d79">KfMatrix::Symmetric</a>);</div>
<div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;</div>
<div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;      node-&gt;MMTX-&gt;CopyFrom(node-&gt;V);</div>
<div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;      node-&gt;MMTX-&gt;Invert(<a class="code" href="../../da/dd0/classKfMatrix.html#af15e721b5d8b0758011c193999ac3140a69cbca4a8e8cf9d2ad4596c4c4d05d79">KfMatrix::Symmetric</a>);</div>
<div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;</div>
<div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;      <span class="comment">// Use inverted smoother cov.matrix to calculate (12d);</span></div>
<div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;      <a class="code" href="../../d6/d2a/classKalmanFilter.html#a72a17d3b2c3b2a81ab080676aa9d5060">SVEC</a>-&gt;<a class="code" href="../../da/dd0/classKfMatrix.html#a89d6b58b2efee54f0b3be78dd0ea188b">SetToProduct</a>(node-&gt;CM, node-&gt;xs);</div>
<div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;      <a class="code" href="../../d6/d2a/classKalmanFilter.html#a411c809178a27e377589a79f57ec565c">QVEC</a>-&gt;<a class="code" href="../../da/dd0/classKfMatrix.html#a89d6b58b2efee54f0b3be78dd0ea188b">SetToProduct</a>(node-&gt;H, node-&gt;MMTX, node-&gt;m, <a class="code" href="../../d5/d12/KfMatrix_8h.html#abe96f03ebc0ddf4726fc85940d56ca56">_TRANSPOSE_IN1_</a>);</div>
<div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;      <a class="code" href="../../d6/d2a/classKalmanFilter.html#a72a17d3b2c3b2a81ab080676aa9d5060">SVEC</a>-&gt;<a class="code" href="../../da/dd0/classKfMatrix.html#aaa840cda428c4a650d2207a7f53091d9">Subtract</a>(<a class="code" href="../../d6/d2a/classKalmanFilter.html#a411c809178a27e377589a79f57ec565c">QVEC</a>);</div>
<div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;</div>
<div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;      <a class="code" href="../../d6/d2a/classKalmanFilter.html#a7c6a6b91058b6efa517098c2cd38b862">SMTX</a>-&gt;<a class="code" href="../../da/dd0/classKfMatrix.html#a89d6b58b2efee54f0b3be78dd0ea188b">SetToProduct</a>(node-&gt;H, node-&gt;MMTX, node-&gt;H, <a class="code" href="../../d5/d12/KfMatrix_8h.html#abe96f03ebc0ddf4726fc85940d56ca56">_TRANSPOSE_IN1_</a>);</div>
<div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;      </div>
<div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;      node-&gt;CM-&gt;Subtract(<a class="code" href="../../d6/d2a/classKalmanFilter.html#a7c6a6b91058b6efa517098c2cd38b862">SMTX</a>);</div>
<div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;      node-&gt;CM-&gt;Invert(<a class="code" href="../../da/dd0/classKfMatrix.html#af15e721b5d8b0758011c193999ac3140a69cbca4a8e8cf9d2ad4596c4c4d05d79">KfMatrix::Symmetric</a>);</div>
<div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;</div>
<div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;      node-&gt;xm-&gt;SetToProduct(node-&gt;CM, <a class="code" href="../../d6/d2a/classKalmanFilter.html#a72a17d3b2c3b2a81ab080676aa9d5060">SVEC</a>);</div>
<div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;</div>
<div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;      <span class="comment">// And respective residuals;</span></div>
<div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;      node-&gt;rm-&gt;SetToProduct(node-&gt;H, node-&gt;xm);</div>
<div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;      node-&gt;rm-&gt;SetToDifference(node-&gt;m, node-&gt;rm);</div>
<div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;</div>
<div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;      <span class="comment">// And eventually project node-&gt;CM onto the node space;</span></div>
<div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;      node-&gt;RM-&gt;SetToProduct(node-&gt;H, node-&gt;CM, node-&gt;H, <a class="code" href="../../d5/d12/KfMatrix_8h.html#ac7d936564d7b5fefa168706af5932d3e">_TRANSPOSE_IN3_</a>);</div>
<div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;    } <span class="comment">//if</span></div>
<div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;</div>
<div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;    <span class="comment">// If node was dead for this event, skip all the rest; </span></div>
<div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;    <span class="keywordflow">if</span> (!node-&gt;mFired) <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;    </div>
<div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;    <span class="comment">// Smoothed residuals; </span></div>
<div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;    node-&gt;rs-&gt;SetToProduct(node-&gt;H, node-&gt;xs);</div>
<div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;    node-&gt;rs-&gt;SetToDifference(node-&gt;m, node-&gt;rs);</div>
<div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;</div>
<div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;    <span class="comment">// Covariance matrix of smoothed residuals;</span></div>
<div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;    node-&gt;RS-&gt;SetToProduct(node-&gt;H, node-&gt;CS, node-&gt;H, <a class="code" href="../../d5/d12/KfMatrix_8h.html#ac7d936564d7b5fefa168706af5932d3e">_TRANSPOSE_IN3_</a>);</div>
<div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;    <span class="comment">//node-&gt;RS-&gt;Print();</span></div>
<div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;    node-&gt;RS-&gt;SetToDifference(node-&gt;V, node-&gt;RS);</div>
<div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2a/classKalmanFilter.html#ac37d594f0e018efd90014a92c89cc151">mForceSymmetrization</a>) node-&gt;RS-&gt;ForceSymmetric();</div>
<div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;    </div>
<div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;    <span class="comment">// Smoothed chi^2; </span></div>
<div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;    node-&gt;MMTX-&gt;CopyFrom(node-&gt;RS);</div>
<div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;    <span class="keywordflow">if</span> (node-&gt;MMTX-&gt;Invert(<a class="code" href="../../da/dd0/classKfMatrix.html#af15e721b5d8b0758011c193999ac3140a69cbca4a8e8cf9d2ad4596c4c4d05d79">KfMatrix::Symmetric</a>)) {</div>
<div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2a/classKalmanFilter.html#abe11dff14af0725ee55673ae51a45f43">mVerbosityLevel</a> &gt;= <a class="code" href="../../d6/d2a/classKalmanFilter.html#a51d93c6451f96b52a3681287b8ae2dadaf0e967b6e9a622677e42818f3da52f74">KalmanFilter::Error</a>)</div>
<div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;  --&gt; Z=%7.1f, RS[0][0] = %20.15f\n&quot;</span>, node-&gt;GetZ(), node-&gt;RS-&gt;KFM(0,0));</div>
<div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;      <a class="code" href="../../dc/db1/KalmanFilter_8h.html#a50621379a5bea7702bce41fb1eb509e3">_KF_RETURN_</a>(<a class="code" href="../../dc/db1/KalmanFilter_8h.html#abfa3782f9a0716f8b2a73f9603e4f9cc">_DSINV_FAILURE_</a>, <span class="stringliteral">&quot;DSINV() failed (smoother)!\n&quot;</span>, <a class="code" href="../../d6/d2a/classKalmanFilter.html#a51d93c6451f96b52a3681287b8ae2dadaf0e967b6e9a622677e42818f3da52f74">KalmanFilter::Error</a>);</div>
<div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;    } <span class="comment">//if</span></div>
<div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;    node-&gt;rs-&gt;VectorLengthSquare(node-&gt;MMTX, &amp;node-&gt;mSmootherChiSquare);</div>
<div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;    <span class="keywordflow">if</span> (node-&gt;mSmootherChiSquare &lt;= 0.0) {</div>
<div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;      <span class="comment">//printf(&quot;%f %f %f %f\n&quot;, node-&gt;MMTX-&gt;KFM(0,0), node-&gt;MMTX-&gt;KFM(1,0), </span></div>
<div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;      <span class="comment">//     node-&gt;MMTX-&gt;KFM(0,1), node-&gt;MMTX-&gt;KFM(1,1));</span></div>
<div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;      <span class="comment">//node-&gt;V-&gt;Print();</span></div>
<div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;      <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;%f: smother chi^2 = %f\n&quot;</span>, node-&gt;GetZ(), node-&gt;mSmootherChiSquare);</div>
<div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;      <span class="comment">//exit(0);</span></div>
<div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;    }</div>
<div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;    <span class="comment">// FIXME: use this value in all places rather than calculating it every time new;</span></div>
<div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;    node-&gt;mSmootherChiSquareCCDF = </div>
<div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;      ROOT::Math::chisquared_cdf_c(node-&gt;GetSmootherChiSquare(), node-&gt;GetMdim());</div>
<div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;</div>
<div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;    <span class="comment">// Assign worst knode pointers;</span></div>
<div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d2a/classKalmanFilter.html#acfbed2ec72e2a34ba2692e83aeb10593">mWorstSmootherNode</a> || </div>
<div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;  node-&gt;<a class="code" href="../../de/ddb/classKalmanNode.html#a8b08df61ac46c1677eb4836f700dbb35">mSmootherChiSquare</a> &gt; </div>
<div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;  <a class="code" href="../../d6/d2a/classKalmanFilter.html#acfbed2ec72e2a34ba2692e83aeb10593">mWorstSmootherNode</a>-&gt;<a class="code" href="../../de/ddb/classKalmanNode.html#a8b08df61ac46c1677eb4836f700dbb35">mSmootherChiSquare</a>)</div>
<div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;      <a class="code" href="../../d6/d2a/classKalmanFilter.html#acfbed2ec72e2a34ba2692e83aeb10593">mWorstSmootherNode</a> = node;</div>
<div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d2a/classKalmanFilter.html#aa19875e29a67684005c04871611bbbc7">mWorstResettableSmootherNode</a> || </div>
<div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;  node-&gt;<a class="code" href="../../de/ddb/classKalmanNode.html#a8b08df61ac46c1677eb4836f700dbb35">mSmootherChiSquare</a> &gt; </div>
<div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;  <a class="code" href="../../d6/d2a/classKalmanFilter.html#aa19875e29a67684005c04871611bbbc7">mWorstResettableSmootherNode</a>-&gt;<a class="code" href="../../de/ddb/classKalmanNode.html#a8b08df61ac46c1677eb4836f700dbb35">mSmootherChiSquare</a>) {</div>
<div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;      <span class="comment">// Check that knode can be reset;</span></div>
<div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;      <span class="keywordtype">int</span> gr, resettable = 1;</div>
<div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;</div>
<div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;      <span class="keywordflow">for</span>(gr=0; gr&lt;node-&gt;mNodeGroupNum; gr++) {</div>
<div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;  <a class="code" href="../../d1/d50/classNodeGroup.html">NodeGroup</a> *group = (<a class="code" href="../../d1/d50/classNodeGroup.html">NodeGroup</a>*)node-&gt;mNodeGroups[gr];</div>
<div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;</div>
<div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;  if (group-&gt;<a class="code" href="../../d1/d50/classNodeGroup.html#aa9972726faa96ee0b3f3dba0d3bc63e7">mNdfControlFlag</a> &amp;&amp; </div>
<div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;      group-&gt;<a class="code" href="../../d1/d50/classNodeGroup.html#a27b9769357c80eb1531f338b45ce2c14">mFiredNodeNum</a> &lt;= group-&gt;<a class="code" href="../../d1/d50/classNodeGroup.html#a57e9796af95a88e88a249fd8bfa0e6eb">mFiredNodeNumMin</a>) {</div>
<div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;    resettable = 0;</div>
<div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;  } <span class="comment">//if</span></div>
<div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;      } <span class="comment">//for gr</span></div>
<div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;</div>
<div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;      <span class="keywordflow">if</span> (resettable) <a class="code" href="../../d6/d2a/classKalmanFilter.html#aa19875e29a67684005c04871611bbbc7">mWorstResettableSmootherNode</a> = node;</div>
<div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;    } <span class="comment">//if</span></div>
<div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;</div>
<div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;    <span class="comment">// Really so?;</span></div>
<div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;    <span class="keywordflow">if</span> (node == <a class="code" href="../../d6/d2a/classKalmanFilter.html#a31b0db5559d7b3bd91dd02edd244a0c7">mLastStart</a>) <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;  } <span class="comment">//for node</span></div>
<div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;</div>
<div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;  <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;} <span class="comment">// KalmanFilter::SmootherPass()</span></div>
<div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;</div>
<div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;<span class="comment">// =======================================================================================</span></div>
<div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;</div>
<div class="line"><a name="l00744"></a><span class="lineno"><a class="code" href="../../d6/d2a/classKalmanFilter.html#ad511380e4a3b0a4c044e807701d80e75">  744</a></span>&#160;<span class="keywordtype">unsigned</span> <a class="code" href="../../d6/d2a/classKalmanFilter.html#ad511380e4a3b0a4c044e807701d80e75">KalmanFilter::FullChain</a>(<a class="code" href="../../de/ddb/classKalmanNode.html">KalmanNode</a> *<a class="code" href="../../dc/de5/PHG4mRICHDetector_8cc.html#a10e6010f5f8222befd1273192d72ddf5">start</a>, </div>
<div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;         <a class="code" href="../../de/ddb/classKalmanNode.html">KalmanNode</a> *end, <a class="code" href="../../d6/d2a/classKalmanFilter.html#a5592d57642d917049cd5df82ba5f1301">KalmanFilter::Direction</a> fb, <span class="keywordtype">int</span> mode)</div>
<div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;{</div>
<div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;  <span class="keywordtype">unsigned</span> ret, outlier_order_violation = 0;</div>
<div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;</div>
<div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;  <span class="comment">// Sanity check; do not mind to do it every time and set special bit;</span></div>
<div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;  <span class="keywordflow">if</span> (((mode &amp; <a class="code" href="../../dc/db1/KalmanFilter_8h.html#a9cd1e20ba6521cb47979094f6440408a">_TRUST_SMOOTHER_FCN_</a>) &amp;&amp; !<a class="code" href="../../d6/d2a/classKalmanFilter.html#a73c606d3c5d8f511e8540158996c0311">mMinSmootherChiSquareCCDF</a>) ||</div>
<div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;      ((mode &amp; <a class="code" href="../../dc/db1/KalmanFilter_8h.html#a2a6594bcf60cb583e8ef63b348db37d1">_TRUST_FILTER_FCN_</a>)   &amp;&amp; !<a class="code" href="../../d6/d2a/classKalmanFilter.html#aa3cc65d9936401e3195b3a483deff0cb">mMinFilterChiSquareCCDF</a>))</div>
<div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../dc/db1/KalmanFilter_8h.html#accf16f3c0da55ced651a48e682e670e3">_CHAIN_FAILURE_</a>;</div>
<div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;</div>
<div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;  <span class="comment">// Initialize few global root frame variables;</span></div>
<div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;  <a class="code" href="../../d6/d2a/classKalmanFilter.html#a24ac24ab2b5434f7654fd70349ed344f">mChainRejectedNodeNum</a> = <a class="code" href="../../d6/d2a/classKalmanFilter.html#a177718097efbebc2168d006ca607c4ac">mExtraReturnBits</a> = 0;</div>
<div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;</div>
<div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;  <span class="comment">// Run forward filter; if failed, return immediately;</span></div>
<div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;  <span class="keywordflow">if</span> ((ret = <a class="code" href="../../d6/d2a/classKalmanFilter.html#a3dc79ff2ca154297d6d86f3dee8f0194">FilterPass</a>(start, end, fb))) <a class="code" href="../../dc/db1/KalmanFilter_8h.html#a716b1c9921ccae54fbe3eb5687526591">_CHAIN_RETURN_</a>(ret);</div>
<div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;</div>
<div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;  <span class="comment">// Then iteratively run smoother, remove worst outlier and rerun </span></div>
<div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;  <span class="comment">// forward filter starting from the removed node;</span></div>
<div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;  <span class="keywordflow">for</span>( ; ; )</div>
<div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;  {</div>
<div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;    <span class="comment">// If smoother failed, return failure code immediately; </span></div>
<div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;    <span class="keywordflow">if</span> ((ret = <a class="code" href="../../d6/d2a/classKalmanFilter.html#a71cf5c851023da4b228e3654cca58928">SmootherPass</a>())) <a class="code" href="../../dc/db1/KalmanFilter_8h.html#a716b1c9921ccae54fbe3eb5687526591">_CHAIN_RETURN_</a>(ret|outlier_order_violation);</div>
<div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;    </div>
<div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;    <span class="comment">// Check that have enough fired nodes at start up; but do it after </span></div>
<div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;    <span class="comment">// smoother so that some track fit is available anyway;</span></div>
<div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;    {</div>
<div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;      <span class="comment">// NB: assume that if there were no hits in this group at all,</span></div>
<div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;      <span class="comment">// this is NOT a failure (for instance short HERMES tracks may</span></div>
<div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;      <span class="comment">// have no BC3/4 hits at all; or long tracks may have no MC hits); </span></div>
<div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;      <span class="comment">// this is a ~hack, I admit; and actually this loop should be </span></div>
<div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;      <span class="comment">// run only once, since &#39;group-&gt;mFiredNodeNum&#39; can not go below</span></div>
<div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;      <span class="comment">// &#39;group-&gt;mFiredNodeNumMin&#39; in the above infinite loop;</span></div>
<div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;      <span class="keywordflow">for</span>( <a class="code" href="../../d1/d50/classNodeGroup.html">NodeGroup</a> *group=<a class="code" href="../../d6/d2a/classKalmanFilter.html#afb318b6582f705dbf02fd79005e125b2">mNodeGroups</a>; group; group=group-&gt;<a class="code" href="../../d1/d50/classNodeGroup.html#a06b36a722306b8020115bcb6f8d501c7">mNextGroup</a>) {</div>
<div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;  <span class="comment">//printf(&quot;%d fired nodes ...\n&quot;, group-&gt;mFiredNodeNum);</span></div>
<div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;</div>
<div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;  <span class="keywordflow">if</span> (group-&gt;mNdfControlFlag &amp;&amp; </div>
<div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;      group-&gt;mFiredNodeNum &lt; group-&gt;mFiredNodeNumMin)</div>
<div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;    <span class="comment">// So if _NDF_FAILURE_ bit is set and _WORST_NODE_IMMUTABLE_</span></div>
<div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;    <span class="comment">// is not, this means start-up failure here, right?;</span></div>
<div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;    <a class="code" href="../../dc/db1/KalmanFilter_8h.html#a716b1c9921ccae54fbe3eb5687526591">_CHAIN_RETURN_</a>(<a class="code" href="../../dc/db1/KalmanFilter_8h.html#a85505cf60a8f769d70a42d03170af1a7">_NDF_FAILURE_</a>);</div>
<div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;      } <span class="comment">//for group</span></div>
<div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;    } </div>
<div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;    </div>
<div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;    <span class="comment">// Ok, so now take a decision; looks tricky; </span></div>
<div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;    {</div>
<div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;      <span class="keywordtype">double</span> worst_smoother_prob = </div>
<div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;  ROOT::Math::chisquared_cdf_c(<a class="code" href="../../d6/d2a/classKalmanFilter.html#acfbed2ec72e2a34ba2692e83aeb10593">mWorstSmootherNode</a>-&gt;<a class="code" href="../../de/ddb/classKalmanNode.html#a8b08df61ac46c1677eb4836f700dbb35">mSmootherChiSquare</a>, </div>
<div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;             <a class="code" href="../../d6/d2a/classKalmanFilter.html#acfbed2ec72e2a34ba2692e83aeb10593">mWorstSmootherNode</a>-&gt;<a class="code" href="../../de/ddb/classKalmanNode.html#a51e739402d1bebf0c27759b0b0be13d9">mDim</a>);</div>
<div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;</div>
<div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;      <span class="comment">// The only way to return 0 code; both overall filter chi^2</span></div>
<div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;      <span class="comment">// and worst node smoother chi^2 are either within limits or</span></div>
<div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;      <span class="comment">// should not be trusted at all;</span></div>
<div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;      <span class="keywordflow">if</span> ((worst_smoother_prob &gt; <a class="code" href="../../d6/d2a/classKalmanFilter.html#a73c606d3c5d8f511e8540158996c0311">mMinSmootherChiSquareCCDF</a> || </div>
<div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;     !(mode &amp; _TRUST_SMOOTHER_FCN_)) &amp;&amp;</div>
<div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;    (<a class="code" href="../../d6/d2a/classKalmanFilter.html#ac08d0ab4bba617db8428a1a3ef030725">mFilterChiSquareCCDF</a> &gt; <a class="code" href="../../d6/d2a/classKalmanFilter.html#aa3cc65d9936401e3195b3a483deff0cb">mMinFilterChiSquareCCDF</a> || </div>
<div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;     !(mode &amp; _TRUST_FILTER_FCN_)))</div>
<div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;  <a class="code" href="../../dc/db1/KalmanFilter_8h.html#a716b1c9921ccae54fbe3eb5687526591">_CHAIN_RETURN_</a>(outlier_order_violation);</div>
<div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;</div>
<div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;      <span class="comment">// Ok, then something is not good; if smoother chi^2 is trusted</span></div>
<div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;      <span class="comment">// and there is a bad node, outlier removal procedure will </span></div>
<div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;      <span class="comment">// continue, no care needed; if filter chi^2 is trusted, it is</span></div>
<div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;      <span class="comment">// a bit more complicated since smoother chi^2 may also be </span></div>
<div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;      <span class="comment">// trusted and there may be no bad nodes left;</span></div>
<div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2a/classKalmanFilter.html#ac08d0ab4bba617db8428a1a3ef030725">mFilterChiSquareCCDF</a> &lt; <a class="code" href="../../d6/d2a/classKalmanFilter.html#aa3cc65d9936401e3195b3a483deff0cb">mMinFilterChiSquareCCDF</a> &amp;&amp;</div>
<div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;    (mode &amp; _TRUST_FILTER_FCN_) &amp;&amp;</div>
<div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;    worst_smoother_prob &gt; <a class="code" href="../../d6/d2a/classKalmanFilter.html#a73c606d3c5d8f511e8540158996c0311">mMinSmootherChiSquareCCDF</a> &amp;&amp;</div>
<div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;    (mode &amp; _TRUST_SMOOTHER_FCN_))</div>
<div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;  <a class="code" href="../../dc/db1/KalmanFilter_8h.html#a716b1c9921ccae54fbe3eb5687526591">_CHAIN_RETURN_</a>(<a class="code" href="../../dc/db1/KalmanFilter_8h.html#a362740dbdfab3ccaa8a4b598e2d8a876">_STRUST_FAILURE_</a>|outlier_order_violation);</div>
<div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;    } </div>
<div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;</div>
<div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;    <span class="comment">// NB: there can be no node which can be removed --&gt; </span></div>
<div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;    <span class="comment">// then return immediately; and set both bits;</span></div>
<div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d2a/classKalmanFilter.html#aa19875e29a67684005c04871611bbbc7">mWorstResettableSmootherNode</a>)</div>
<div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;      <a class="code" href="../../dc/db1/KalmanFilter_8h.html#a716b1c9921ccae54fbe3eb5687526591">_CHAIN_RETURN_</a>(<a class="code" href="../../dc/db1/KalmanFilter_8h.html#a85505cf60a8f769d70a42d03170af1a7">_NDF_FAILURE_</a>|<a class="code" href="../../dc/db1/KalmanFilter_8h.html#a6ee6bdb4de6c892ba1a1b4b59791a81f">_WORST_NODE_IMMUTABLE_</a>);</div>
<div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;</div>
<div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;    <span class="comment">// Check that node to be removed is really the worst one;</span></div>
<div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2a/classKalmanFilter.html#aa19875e29a67684005c04871611bbbc7">mWorstResettableSmootherNode</a> != </div>
<div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;  <a class="code" href="../../d6/d2a/classKalmanFilter.html#acfbed2ec72e2a34ba2692e83aeb10593">mWorstSmootherNode</a>)</div>
<div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;      outlier_order_violation = <a class="code" href="../../dc/db1/KalmanFilter_8h.html#a6ee6bdb4de6c892ba1a1b4b59791a81f">_WORST_NODE_IMMUTABLE_</a>;</div>
<div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;</div>
<div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;    <span class="comment">// Turn worst node off and redo forward filtering algebra </span></div>
<div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;    <span class="comment">// starting from this node; NB: no need to recalculate </span></div>
<div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;    <span class="comment">// x0[], FR[][] &amp; Q[][] --&gt; save CPU time;</span></div>
<div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2a/classKalmanFilter.html#abe11dff14af0725ee55673ae51a45f43">mVerbosityLevel</a> &gt;= <a class="code" href="../../d6/d2a/classKalmanFilter.html#a51d93c6451f96b52a3681287b8ae2dadaf6a5b8d4803dd556e653b5019f3ae931">KalmanFilter::Info</a>)</div>
<div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;      <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;chi^2 = %8.2f -&gt; prob %10.7f -&gt; removing %s (chi^2 incr %8.2f)\n&quot;</span>, </div>
<div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;       <a class="code" href="../../d6/d2a/classKalmanFilter.html#aeb5d6ab574df6feba9cfb33eb7dbd862">mFilterChiSquare</a>, <a class="code" href="../../d6/d2a/classKalmanFilter.html#ac08d0ab4bba617db8428a1a3ef030725">mFilterChiSquareCCDF</a>, <a class="code" href="../../d6/d2a/classKalmanFilter.html#aa19875e29a67684005c04871611bbbc7">mWorstResettableSmootherNode</a>-&gt;<a class="code" href="../../de/ddb/classKalmanNode.html#a1306bb9d8469ee77e2693bf16383a395">mName</a>,</div>
<div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;       <a class="code" href="../../d6/d2a/classKalmanFilter.html#acfbed2ec72e2a34ba2692e83aeb10593">mWorstSmootherNode</a>-&gt;<a class="code" href="../../de/ddb/classKalmanNode.html#a8b08df61ac46c1677eb4836f700dbb35">mSmootherChiSquare</a>);</div>
<div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;    <a class="code" href="../../d6/d2a/classKalmanFilter.html#aa19875e29a67684005c04871611bbbc7">mWorstResettableSmootherNode</a>-&gt;<a class="code" href="../../de/ddb/classKalmanNode.html#aad0719dc76767ddfd66dd8553ee2d96c">ResetFiredFlag</a>();</div>
<div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;    <a class="code" href="../../d6/d2a/classKalmanFilter.html#a24ac24ab2b5434f7654fd70349ed344f">mChainRejectedNodeNum</a>++;</div>
<div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;</div>
<div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;    <span class="comment">// Repeat Kalman filter matrix calculations starting from </span></div>
<div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;    <span class="comment">// the removed outlier node;</span></div>
<div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;    <span class="keywordflow">if</span> ((ret = <a class="code" href="../../d6/d2a/classKalmanFilter.html#a45d7662a8e30d56baa92e9eb43967128">DoFilterAlgebra</a>(<a class="code" href="../../d6/d2a/classKalmanFilter.html#aa19875e29a67684005c04871611bbbc7">mWorstResettableSmootherNode</a>, end, fb)))</div>
<div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;      <a class="code" href="../../dc/db1/KalmanFilter_8h.html#a716b1c9921ccae54fbe3eb5687526591">_CHAIN_RETURN_</a>(ret|outlier_order_violation);</div>
<div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;</div>
<div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;    <span class="comment">// Recalculate filter ndf &amp; chi^2 from scratch;</span></div>
<div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;    <a class="code" href="../../d6/d2a/classKalmanFilter.html#abb88864f4aa74aa6f35657345ee7f268">CalculateFilterStat</a>();</div>
<div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;  } <span class="comment">//for inf</span></div>
<div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;} <span class="comment">// KalmanFilter::FullChain()</span></div>
<div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;</div>
<div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;<span class="comment">// =======================================================================================</span></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->

<!-- start footer part -->
<div id="nav-path" class="navpath">
	<!-- id is needed for treeview function! -->
	<ul>
		<li class="navelem"><a class="el" href="../../dir_d7aa557fabe0dbc710c3133bbb38c9dd.html">EicRoot</a></li><li class="navelem"><a class="el" href="../../dir_6c2f52c7c502fdce4930bf509aa7892f.html">blob</a></li><li class="navelem"><a class="el" href="../../dir_b7851b2c5844943c52ef11ccfc82d757.html">master</a></li><li class="navelem"><a class="el" href="../../dir_1bfc7400c7d9621b65a7f5dd68fa40ba.html">eic</a></li><li class="navelem"><a class="el" href="../../dir_ca9e3e8fb1c36e79f2c9b0050fa7901f.html">htc</a></li><li class="navelem"><a class="el" href="../../d5/dc2/KalmanFilter_8cxx.html">KalmanFilter.cxx</a></li>
		<li class="footer">
		Built by <a href="mailto:jhuang@bnl.gov">Jin Huang</a></em>.
			updated: <em>Mon Jan 22 2024 12:43:35</em> using <a
			href="http://www.doxygen.org/index.html"> <img class="footer"
				src="../../doxygen.png" alt="doxygen" /></a> 1.8.2 
				with <a href="https://github.com/eic">EIC GitHub integration</a>
		</li>
	</ul>
</div>
</body>
</html>
